

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Table of Contents &mdash; donatello 0.0.1 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="genindex.html"/>
        <link rel="search" title="Search" href="search.html"/>
    <link rel="top" title="donatello 0.0.1 documentation" href="index.html"/>
        <link rel="next" title="donatello package" href="donatello.html"/>
        <link rel="prev" title="Model Types" href="model_types.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> donatello
          

          
          </a>

          
            
            
              <div class="version">
                0.0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="readme_link.html">Readme File</a></li>
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="sculpture.html">Sculpture</a></li>
<li class="toctree-l1"><a class="reference internal" href="model_types.html">Model Types</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Table of Contents</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#Evaluation-in-the-context-of-bias,-caveats,-known-issues,-and-time-constraints">Evaluation in the context of bias, caveats, known issues, and time-constraints</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Introduction-&amp;-post-hoc-bias.">Introduction &amp; post-hoc bias.</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Optimization-&amp;-user-sessions-+-redundant-searches.">Optimization &amp; user sessions + redundant searches.</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#Ranking-evaluation-within-the-context-of-“impressed”-listings">Ranking evaluation within the context of “impressed” listings</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#KPI:-NDCG-of-uniquely-defined-queries-on-a-given-day">KPI: NDCG of uniquely defined queries on a given day</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Caveat">Caveat</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#Result-volume">Result volume</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#Key-by-search_id-(most-restrictive)">Key by search_id (most restrictive)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Key-by-user,-date-range,-and-market-(least-restrictive-within-reason)">Key by user, date range, and market (least restrictive within reason)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Key-by-user,-full-query-parameters,-and-date-of-search.">Key by user, full query parameters, and date of search.</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Impact-of-key-parameterization">Impact of key parameterization</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Number-of-searches-per-user-per-day">Number of searches per user per day</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#Modeling">Modeling</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Baseline">Baseline</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Recasting">Recasting</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Donatello">Donatello</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Cross-validation-metrics">Cross validation metrics</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#Feature-Engineering">Feature Engineering</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#NULLS">NULLS</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Missing-value-semantic-assumptions">Missing value semantic assumptions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Transforms">Transforms</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#Model-Development:-future-work">Model Development: future work</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#New-Listings:-UX,-dispersion,-and-ML-scoring">New Listings: UX, dispersion, and ML scoring</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="donatello.html">donatello package</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="index.html">donatello</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="index.html">Docs</a> &raquo;</li>
      
    <li>Table of Contents</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/ranking_search.ipynb.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput,
div.nbinput div.prompt,
div.nbinput div.input_area,
div.nbinput div[class*=highlight],
div.nbinput div[class*=highlight] pre,
div.nboutput,
div.nbinput div.prompt,
div.nbinput div.output_area,
div.nboutput div[class*=highlight],
div.nboutput div[class*=highlight] pre {
    background: none;
    border: none;
    padding: 0 0;
    margin: 0;
    box-shadow: none;
}

/* avoid gaps between output lines */
div.nboutput div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput,
div.nboutput {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput,
    div.nboutput {
        flex-direction: column;
    }
}

/* input container */
div.nbinput {
    padding-top: 5px;
}

/* last container */
div.nblast {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput div.prompt,
div.nboutput div.prompt {
    min-width: 5ex;
    padding-top: 0.4em;
    padding-right: 0.4em;
    text-align: right;
    flex: 0;
}
@media (max-width: 540px) {
    div.nbinput div.prompt,
    div.nboutput div.prompt {
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput div.prompt.empty {
        padding: 0;
    }
}

/* disable scrollbars on prompts */
div.nbinput div.prompt pre,
div.nboutput div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput div.input_area,
div.nboutput div.output_area {
    padding: 0.4em;
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput div.input_area,
    div.nboutput div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    background: #f5f5f5;
}

/* override MathJax center alignment in output cells */
div.nboutput div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput div.math p {
    text-align: left;
}

/* standard error */
div.nboutput div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast,
.nboutput.nblast {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast + .nbinput {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="section" id="Table-of-Contents">
<h1>Table of Contents<a class="headerlink" href="#Table-of-Contents" title="Permalink to this headline">¶</a></h1>
<ol class="arabic simple">
<li>Exploration</li>
<li>Evaluation in the context of bias and constraints</li>
<li>Result volumes and selecting an evaluation measure</li>
<li>Baseline</li>
<li>Feature engineering</li>
<li>Holdout evaluation</li>
<li>New Listings: UX, dispersion, and ML scoring</li>
</ol>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span> <span class="nn">haversine</span> <span class="kn">import</span> <span class="n">haversine</span>
<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.max_columns&#39;</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.max_rows&#39;</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">mode</span><span class="o">.</span><span class="n">chained_assignment</span> <span class="o">=</span> <span class="bp">None</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;KMP_DUPLICATE_LIB_OK&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;True&#39;</span>

</pre></div>
</div>
</div>
<p>I’ll begin by loading the data and splitting off an initial subset of the data to inspect to build intuition around and a framework for the assignment’s approach.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">df_all</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;data/takehome_data.tsv&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">low_memory</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">df_all</span><span class="o">.</span><span class="n">ds_search</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="output_area highlight-none notranslate"><div class="highlight"><pre>
<span></span>11/20/18    25608
11/21/18    27548
11/22/18    28374
11/23/18    27344
11/25/18    29007
11/26/18    39707
Name: ds_search, dtype: int64
</pre></div>
</div>
</div>
<p>In the next section I’ll call out the impact of evaluating user searches vs user experiences. But given the abscence of data on 11/24/18 I’ll break apart the dataset into searches executed before 11/24/18 as the training dataset, searches on 11/25/18 as an evaluation set, and 11/26/18 as a final hold out set</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="nb">sorted</span><span class="p">(</span><span class="n">df_all</span><span class="o">.</span><span class="n">ds_search</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span> <span class="c1"># no nulls</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="output_area highlight-none notranslate"><div class="highlight"><pre>
<span></span>[&#39;11/20/18&#39;, &#39;11/21/18&#39;, &#39;11/22/18&#39;, &#39;11/23/18&#39;, &#39;11/25/18&#39;, &#39;11/26/18&#39;]
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">df_all</span><span class="p">[</span><span class="s1">&#39;ts_search&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df_all</span><span class="o">.</span><span class="n">ts_search</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># unique users and listing count in training set</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df_all</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_all</span><span class="o">.</span><span class="n">ds_search</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s1">&#39;11/20/18&#39;</span><span class="p">,</span> <span class="s1">&#39;11/21/18&#39;</span><span class="p">,</span> <span class="s1">&#39;11/22/18&#39;</span><span class="p">,</span> <span class="s1">&#39;11/23/18&#39;</span><span class="p">])]</span>
<span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">id_user</span><span class="o">.</span><span class="n">unique</span><span class="p">()),</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">id_listing</span><span class="o">.</span><span class="n">unique</span><span class="p">())],</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;users&#39;</span><span class="p">,</span><span class="s1">&#39;listings&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>users</th>
      <th>listings</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2271</td>
      <td>25928</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">validation_df</span> <span class="o">=</span> <span class="n">df_all</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_all</span><span class="o">.</span><span class="n">ds_search</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s1">&#39;11/25/18&#39;</span><span class="p">])]</span>
<span class="n">holdout_df</span> <span class="o">=</span> <span class="n">df_all</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_all</span><span class="o">.</span><span class="n">ds_search</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s1">&#39;11/26/18&#39;</span><span class="p">])]</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_all</span><span class="p">)</span> <span class="o">==</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="n">df</span><span class="p">,</span> <span class="n">validation_df</span><span class="p">,</span> <span class="n">holdout_df</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">df</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="output_area highlight-none notranslate"><div class="highlight"><pre>
<span></span>(108874, 49)
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">counts</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;label&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">id_search</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="s1">&#39;book&#39;</span><span class="p">,</span> <span class="s1">&#39;host_contact&#39;</span><span class="p">,</span> <span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="s1">&#39;impression&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;records&#39;</span><span class="p">)</span>
<span class="n">cumulative</span> <span class="o">=</span> <span class="n">counts</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;cumulative_counts&#39;</span><span class="p">)</span>
<span class="n">funnel</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">counts</span><span class="p">,</span> <span class="n">cumulative</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;cumulative_counts&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="n">funnel</span><span class="p">[</span><span class="s1">&#39;percent&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">funnel</span><span class="o">.</span><span class="n">cumulative_counts</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span> <span class="o">/</span> <span class="n">funnel</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;impression&#39;</span><span class="p">,</span> <span class="s1">&#39;cumulative_counts&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">funnel</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>records</th>
      <th>cumulative_counts</th>
      <th>percent</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>impression</th>
      <td>81164</td>
      <td>108874</td>
      <td>100.0</td>
    </tr>
    <tr>
      <th>click</th>
      <td>24727</td>
      <td>27710</td>
      <td>25.5</td>
    </tr>
    <tr>
      <th>host_contact</th>
      <td>1683</td>
      <td>2983</td>
      <td>2.7</td>
    </tr>
    <tr>
      <th>book</th>
      <td>1300</td>
      <td>1300</td>
      <td>1.2</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>Note: this is funnel - cumalitive numbers imply made it to this step or farther down funnel</p>
<div class="section" id="Evaluation-in-the-context-of-bias,-caveats,-known-issues,-and-time-constraints">
<h2>Evaluation in the context of bias, caveats, known issues, and time-constraints<a class="headerlink" href="#Evaluation-in-the-context-of-bias,-caveats,-known-issues,-and-time-constraints" title="Permalink to this headline">¶</a></h2>
<p>The time to solve this problem ( ~1 work day) as well as data availabilty and inherent bias of the dataset are all considerations for the proposed approach. I wil try to combat some of these, call out others, and when possible attempt to leverage the constraint to optimize the system.</p>
<div class="section" id="Introduction-&amp;-post-hoc-bias.">
<h3>Introduction &amp; post-hoc bias.<a class="headerlink" href="#Introduction-&-post-hoc-bias." title="Permalink to this headline">¶</a></h3>
<p>The data available is defined by the user’s interaction with AirBnB’s existing search infrastructure. If AirBnB’s existing infra pushes a listing farther down the queue the user is less likley to receive it as an impression, which prevents that listing from being booked. Because some of the data detailing the availability of a listing is not accessable, such as for the given date range requested “what listings are available”, I will take an approach to optimize for the information we have and
discuss how it could be integrated to existing systems noting this bias.</p>
</div>
<div class="section" id="Optimization-&amp;-user-sessions-+-redundant-searches.">
<h3>Optimization &amp; user sessions + redundant searches.<a class="headerlink" href="#Optimization-&-user-sessions-+-redundant-searches." title="Permalink to this headline">¶</a></h3>
<p>Having a strong dialogue with relevant stakeholders to better understand the objectives is a critical part of integrating machine learning products to optimize for business impact. Here I see an additional layer of importance due to the interactions with existing infra. The first issue is called out above, but the second is with respect to the primary key / atomic unit by which we evaluate the model. A user can only book one listing per day. In order to make that booking a user will often
execute multiple searches, possibly in quick succession and/or over the course of longer time periods.</p>
<p>If the ultimate goal is to optimize for the booking rate per search this is subtley different from the goal to optimize for the number of a user’s booked trips and/or the number of days a user spends staying at AirBnB accommodations. Each of those frames modify the manner in which search requests can be pooled, represented as coelesce searches into windows to quantifably evaluate the models relationship to the user.</p>
<p>I will build a system to augment the existing search infrastructure, by ranking the results of the impressions served by the search engine within a window that skews but does not entirely concede towards bias removal at a cost of data density (more on that two sections below). Work in this area would be critical to the improvement of this model in the future.</p>
<p>Note - I recognize that to serve listings an initial score is needed to yield impressions and this is not that score.</p>
<div class="section" id="Ranking-evaluation-within-the-context-of-“impressed”-listings">
<h4>Ranking evaluation within the context of “impressed” listings<a class="headerlink" href="#Ranking-evaluation-within-the-context-of-“impressed”-listings" title="Permalink to this headline">¶</a></h4>
<p>This system will be a ranking system to order listings based on how likely a user is to book the listing given the metadata supplied in the search query with discussion and future addressment of other business goals and impacts. This ordering assumes existing infrastructure enforces hard rules - such as listing availability, price bounds, guest capacity and other hard requirements - are already enforced and this system will decide how to order those results - “impressions” - for the user.</p>
</div>
</div>
<div class="section" id="KPI:-NDCG-of-uniquely-defined-queries-on-a-given-day">
<h3>KPI: NDCG of uniquely defined queries on a given day<a class="headerlink" href="#KPI:-NDCG-of-uniquely-defined-queries-on-a-given-day" title="Permalink to this headline">¶</a></h3>
<p>Normalized discounted cumlative gain of the “served” listing will help us understand how our model is ranking the available listings. NDCG enables leveraging the ordinal importance of available user interactions (click, host contact, booking) assuming an impression has been made. To evaluate the effectiveness of a given model, the test set will be subset down to searches that have at least one interaction event, because the gain of homogenous collections will not vary across models.</p>
<p>Due to a lack of integration with the existing search engine, I call out that this implementation suffers from not surfacing the most optimal listings across AirBnB’s catalog. Optimizing the likelihood of generating an impression is critical for the end to end success of the search engine. The given dataset could potentially support work in this area, however those estimates will be substantially obfuscated from the lack of other data, such as listing availability for the requested date range,
user session metadata, listing per page, and the units of the query_radius among others. That model would be attempting to learn the outputs of an existing system with obfuscated data rather than an attempting to impact a user behavior.</p>
<p>This product will focus on evaluating the user impressions via pooling uniquely defined user queries on a given day. This metric is imperfect but will yield a larger pool than only search_id pooling and shades closer to the user’s experience. This metric is muddied by the fact that despite the same query by the same user on the same day, new listings could come on the market or reopen and others could come off. Without access to that data, and the width of date ranges queried, the changes in
market conditions will be offset by giving a larger and likely richer collection of listings to evaluate in a given pool. Pool size could be increased by removing the uniquely defined criteria, however removing certain requirements that are interpreted as hard rules (such as price floor / ceiling) would then require an additional filtering step, yielding both additional engineering resources to filter the recommendations before serving in addition to generating bias in the evaluation metric.</p>
</div>
<div class="section" id="Caveat">
<h3>Caveat<a class="headerlink" href="#Caveat" title="Permalink to this headline">¶</a></h3>
<p>NDCG and other similar metrics such as MAP assume monotonic decrease of the relative difference between subsequent ranks. Implied in this definition is that users effectively perceive this return as a steady stream. However, listings are returned in batch (i.e.&nbsp;pages to leaf through or mini batch like rows). The activation energy to go from page 1 to page 2 or the next row off the screen is quite impactful to a user’s response and is not captured in this metric. This is an area to address with
future improvements.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># based on https://gist.github.com/mblondel/7337391. Tests explicitly ripped from gist at bottom of notebook</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>

<span class="k">def</span> <span class="nf">dcg</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_predicted</span><span class="p">,</span> <span class="n">gain</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="o">**</span> <span class="n">x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)):</span>
    <span class="n">gained</span> <span class="o">=</span> <span class="n">gain</span><span class="p">(</span><span class="n">y_true</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y_predicted</span><span class="p">))])</span>
    <span class="n">discounted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">gained</span> <span class="o">/</span> <span class="n">discounted</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">ndcg</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_predicted</span><span class="p">,</span> <span class="n">gain</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="o">**</span> <span class="n">x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)):</span>
    <span class="n">max_score</span> <span class="o">=</span> <span class="n">dcg</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_true</span><span class="p">,</span> <span class="n">gain</span><span class="o">=</span><span class="n">gain</span><span class="p">)</span>
    <span class="n">actual_score</span> <span class="o">=</span> <span class="n">dcg</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_predicted</span><span class="p">,</span> <span class="n">gain</span><span class="o">=</span><span class="n">gain</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">actual_score</span> <span class="o">/</span> <span class="n">max_score</span>
</pre></div>
</div>
</div>
<div class="section" id="Result-volume">
<h4>Result volume<a class="headerlink" href="#Result-volume" title="Permalink to this headline">¶</a></h4>
<p>The number of listings returned will help inform our evaluation criteria. We can see the impact on increasing the pooling volume by loosening uniqueness restrictions and ultimately settle on mini-max esque approach that skews towards removing bias</p>
</div>
</div>
<div class="section" id="Key-by-search_id-(most-restrictive)">
<h3>Key by search_id (most restrictive)<a class="headerlink" href="#Key-by-search_id-(most-restrictive)" title="Permalink to this headline">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">search_id</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;id_search&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">id_user</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>\
<span class="o">.</span><span class="n">to_frame</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;id_user&#39;</span><span class="p">:</span> <span class="s1">&#39;impressions_returned&#39;</span><span class="p">})</span>
<span class="n">search_id</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>impressions_returned</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>38325.000000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>2.840809</td>
    </tr>
    <tr>
      <th>std</th>
      <td>2.232785</td>
    </tr>
    <tr>
      <th>min</th>
      <td>1.000000</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>1.000000</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>2.000000</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>4.000000</td>
    </tr>
    <tr>
      <th>max</th>
      <td>18.000000</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">search_id</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">bins</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;number of records in pool&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;number of pools&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="output_area highlight-none notranslate"><div class="highlight"><pre>
<span></span>Text(0,0.5,&#39;number of pools&#39;)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/ranking_search_20_1.png" src="_images/ranking_search_20_1.png" />
</div>
</div>
</div>
<div class="section" id="Key-by-user,-date-range,-and-market-(least-restrictive-within-reason)">
<h3>Key by user, date range, and market (least restrictive within reason)<a class="headerlink" href="#Key-by-user,-date-range,-and-market-(least-restrictive-within-reason)" title="Permalink to this headline">¶</a></h3>
<p>Without more user event data it’s challenging to correctly coelesce searches. Searches in the same market with overlapping date ranges is one approach with the given data, however there’s nuance to that approach as a cause of this can be user’s considering staying at multiple locations either due to location, cost, number of guests, and availability as well as how those features interact with the listings considerations #TwoSidedMarketplace</p>
<p>As a rough initial cut, given a user can only book in one place, aggregating by date range and user helps coelesce some of our searches while trying to mitigate bias. As we can see in the table below, for user <code class="docutils literal notranslate"><span class="pre">0077431ca40d7d0c028247ecb1da9874</span></code>, the first record and fourth record are more likely independent (although the user could have flexibility with the trip date), while the second or third requests are likely strongly anti-correlated with respect to each other as a condition on booking.</p>
<p>While the volume generated by this approach is appealing, the additional technical overhead of filtering responses and increased bias aren’t justifiable at this point. This work does support the potential value add of future work in the space</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">search_window</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;id_user&#39;</span><span class="p">,</span> <span class="s1">&#39;query_checkin&#39;</span><span class="p">,</span> <span class="s1">&#39;query_checkout&#39;</span><span class="p">,</span> <span class="s1">&#39;query_market&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">id_search</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>\
    <span class="o">.</span><span class="n">to_frame</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;id_search&#39;</span><span class="p">:</span> <span class="s1">&#39;impressions_returned&#39;</span><span class="p">})</span>

<span class="n">search_window</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th>impressions_returned</th>
    </tr>
    <tr>
      <th>id_user</th>
      <th>query_checkin</th>
      <th>query_checkout</th>
      <th>query_market</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>00226cf02c6c8907b096d0637bc84b29</th>
      <th>12/7/18</th>
      <th>12/9/18</th>
      <th>Sao Paulo</th>
      <td>26</td>
    </tr>
    <tr>
      <th rowspan="4" valign="top">0077431ca40d7d0c028247ecb1da9874</th>
      <th>1/9/19</th>
      <th>1/13/19</th>
      <th>Rio de Janeiro</th>
      <td>4</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">2/27/19</th>
      <th>3/6/19</th>
      <th>Rio de Janeiro</th>
      <td>48</td>
    </tr>
    <tr>
      <th>3/7/19</th>
      <th>Rio de Janeiro</th>
      <td>42</td>
    </tr>
    <tr>
      <th>3/13/19</th>
      <th>3/14/19</th>
      <th>Rio de Janeiro</th>
      <td>4</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">0088b42325fa2906faf06cb7bfcef953</th>
      <th rowspan="2" valign="top">12/19/18</th>
      <th>12/25/18</th>
      <th>Rio de Janeiro</th>
      <td>9</td>
    </tr>
    <tr>
      <th>12/26/18</th>
      <th>Rio de Janeiro</th>
      <td>2</td>
    </tr>
    <tr>
      <th>0092c34fa07040ccec7411af56e7ad2a</th>
      <th>12/15/18</th>
      <th>12/20/18</th>
      <th>Rio de Janeiro</th>
      <td>16</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">009b1efd29ceb1277b8e503497a7560b</th>
      <th rowspan="2" valign="top">1/11/19</th>
      <th>1/12/19</th>
      <th>Sao Paulo</th>
      <td>1</td>
    </tr>
    <tr>
      <th>1/15/19</th>
      <th>Sao Paulo</th>
      <td>44</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">search_window</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">bins</span><span class="o">=</span><span class="n">search_window</span><span class="o">.</span><span class="n">impressions_returned</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;number of records in pool&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;number of pools&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="output_area highlight-none notranslate"><div class="highlight"><pre>
<span></span>Text(0,0.5,&#39;number of pools&#39;)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/ranking_search_23_1.png" src="_images/ranking_search_23_1.png" />
</div>
</div>
</div>
<div class="section" id="Key-by-user,-full-query-parameters,-and-date-of-search.">
<h3>Key by user, full query parameters, and date of search.<a class="headerlink" href="#Key-by-user,-full-query-parameters,-and-date-of-search." title="Permalink to this headline">¶</a></h3>
<p>We’ll consider a unique query by it’s attributes and the date of the search. (Again a call out to future pooling work). The search date criteria is included because our test and evaluation data sets are single days each (noting one has 25% more records than the other) so we use this as an attempt to build intuition around the expected size of a pool in our validation set.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">search_window_full_query</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">df</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ds_search&#39;</span><span class="p">,</span> <span class="s1">&#39;id_user&#39;</span><span class="p">]</span>
                                                         <span class="ow">or</span> <span class="n">i</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;query&#39;</span><span class="p">))])</span><span class="o">.</span><span class="n">id_search</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>\
    <span class="o">.</span><span class="n">to_frame</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;id_search&#39;</span><span class="p">:</span> <span class="s1">&#39;impressions_returned&#39;</span><span class="p">})</span>

<span class="n">search_window_full_query</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th>impressions_returned</th>
    </tr>
    <tr>
      <th>id_user</th>
      <th>ds_search</th>
      <th>query_market</th>
      <th>query_checkin</th>
      <th>query_checkout</th>
      <th>query_num_guests</th>
      <th>query_num_children</th>
      <th>query_num_infants</th>
      <th>query_radius</th>
      <th>query_price_max</th>
      <th>query_price_min</th>
      <th>query_center_lat</th>
      <th>query_center_lng</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="12" valign="top">00226cf02c6c8907b096d0637bc84b29</th>
      <th rowspan="12" valign="top">11/21/18</th>
      <th rowspan="12" valign="top">Sao Paulo</th>
      <th rowspan="12" valign="top">12/7/18</th>
      <th rowspan="12" valign="top">12/9/18</th>
      <th rowspan="12" valign="top">2</th>
      <th rowspan="12" valign="top">0</th>
      <th rowspan="12" valign="top">0</th>
      <th>2.861446</th>
      <th>1.070000e+09</th>
      <th>50</th>
      <th>-23.59</th>
      <th>-46.66</th>
      <td>1</td>
    </tr>
    <tr>
      <th>2.861502</th>
      <th>-1.000000e+00</th>
      <th>-1</th>
      <th>-23.58</th>
      <th>-46.64</th>
      <td>4</td>
    </tr>
    <tr>
      <th>2.861563</th>
      <th>1.070000e+09</th>
      <th>50</th>
      <th>-23.58</th>
      <th>-46.66</th>
      <td>1</td>
    </tr>
    <tr>
      <th>2.861606</th>
      <th>1.070000e+09</th>
      <th>50</th>
      <th>-23.58</th>
      <th>-46.65</th>
      <td>4</td>
    </tr>
    <tr>
      <th>2.861710</th>
      <th>1.070000e+09</th>
      <th>50</th>
      <th>-23.58</th>
      <th>-46.66</th>
      <td>1</td>
    </tr>
    <tr>
      <th>2.862022</th>
      <th>-1.000000e+00</th>
      <th>-1</th>
      <th>-23.56</th>
      <th>-46.65</th>
      <td>2</td>
    </tr>
    <tr>
      <th>2.862101</th>
      <th>-1.000000e+00</th>
      <th>-1</th>
      <th>-23.56</th>
      <th>-46.65</th>
      <td>6</td>
    </tr>
    <tr>
      <th>2.862210</th>
      <th>-1.000000e+00</th>
      <th>-1</th>
      <th>-23.55</th>
      <th>-46.66</th>
      <td>1</td>
    </tr>
    <tr>
      <th>5.722837</th>
      <th>-1.000000e+00</th>
      <th>-1</th>
      <th>-23.59</th>
      <th>-46.63</th>
      <td>1</td>
    </tr>
    <tr>
      <th>5.723167</th>
      <th>1.070000e+09</th>
      <th>50</th>
      <th>-23.58</th>
      <th>-46.65</th>
      <td>2</td>
    </tr>
    <tr>
      <th>5.723401</th>
      <th>-1.000000e+00</th>
      <th>-1</th>
      <th>-23.58</th>
      <th>-46.64</th>
      <td>1</td>
    </tr>
    <tr>
      <th>5.723618</th>
      <th>-1.000000e+00</th>
      <th>-1</th>
      <th>-23.57</th>
      <th>-46.64</th>
      <td>2</td>
    </tr>
    <tr>
      <th rowspan="3" valign="top">0077431ca40d7d0c028247ecb1da9874</th>
      <th rowspan="3" valign="top">11/20/18</th>
      <th rowspan="3" valign="top">Rio de Janeiro</th>
      <th rowspan="3" valign="top">2/27/19</th>
      <th rowspan="3" valign="top">3/7/19</th>
      <th rowspan="3" valign="top">2</th>
      <th rowspan="3" valign="top">0</th>
      <th rowspan="3" valign="top">0</th>
      <th rowspan="3" valign="top">1.318039</th>
      <th>-1.000000e+00</th>
      <th>-1</th>
      <th>-22.97</th>
      <th>-43.19</th>
      <td>7</td>
    </tr>
    <tr>
      <th>5.760000e+02</th>
      <th>0</th>
      <th>-22.97</th>
      <th>-43.19</th>
      <td>2</td>
    </tr>
    <tr>
      <th>8.730000e+02</th>
      <th>0</th>
      <th>-22.97</th>
      <th>-43.19</th>
      <td>2</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">search_window_full_query</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">bins</span><span class="o">=</span><span class="n">search_window_full_query</span><span class="o">.</span><span class="n">impressions_returned</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;number of records in pool&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;number of pools&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="output_area highlight-none notranslate"><div class="highlight"><pre>
<span></span>Text(0,0.5,&#39;number of pools&#39;)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/ranking_search_26_1.png" src="_images/ranking_search_26_1.png" />
</div>
</div>
</div>
<div class="section" id="Impact-of-key-parameterization">
<h3>Impact of key parameterization<a class="headerlink" href="#Impact-of-key-parameterization" title="Permalink to this headline">¶</a></h3>
<p>By moving from the most restrictive to a slightly less restrictive pooling we gain an averge of 15% in pool size, noting the lift in gain follows the skew of the volume. Future work in number of searches correlating with likelihood of booking is another interesting area to explore.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">description</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">i</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">percentiles</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">.</span><span class="mi">2</span><span class="p">,</span><span class="o">.</span><span class="mi">8</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span>
                         <span class="p">[</span><span class="n">search_id</span><span class="p">,</span> <span class="n">search_window</span><span class="p">,</span> <span class="n">search_window_full_query</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">description</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;search_id&#39;</span><span class="p">,</span> <span class="s1">&#39;search_window&#39;</span><span class="p">,</span> <span class="s1">&#39;search_window_full_query&#39;</span><span class="p">]</span>
<span class="n">description</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>search_id</th>
      <th>search_window</th>
      <th>search_window_full_query</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>38325.000000</td>
      <td>4542.000000</td>
      <td>33318.000000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>2.840809</td>
      <td>23.970498</td>
      <td>3.267723</td>
    </tr>
    <tr>
      <th>std</th>
      <td>2.232785</td>
      <td>29.156640</td>
      <td>3.295503</td>
    </tr>
    <tr>
      <th>min</th>
      <td>1.000000</td>
      <td>1.000000</td>
      <td>1.000000</td>
    </tr>
    <tr>
      <th>20%</th>
      <td>1.000000</td>
      <td>4.000000</td>
      <td>1.000000</td>
    </tr>
    <tr>
      <th>40%</th>
      <td>2.000000</td>
      <td>9.000000</td>
      <td>2.000000</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>2.000000</td>
      <td>13.000000</td>
      <td>2.000000</td>
    </tr>
    <tr>
      <th>60.0%</th>
      <td>3.000000</td>
      <td>19.000000</td>
      <td>3.000000</td>
    </tr>
    <tr>
      <th>80%</th>
      <td>4.000000</td>
      <td>38.800000</td>
      <td>5.000000</td>
    </tr>
    <tr>
      <th>max</th>
      <td>18.000000</td>
      <td>296.000000</td>
      <td>63.000000</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
</div>
<div class="section" id="Number-of-searches-per-user-per-day">
<h3>Number of searches per user per day<a class="headerlink" href="#Number-of-searches-per-user-per-day" title="Permalink to this headline">¶</a></h3>
<p>There is a lot to explore in user search interactions. I’ll curtail that discussion to allow for more time on the system itself with a last look at user searches per day as support for query parameter based pooling over pooling by search_id only. Here we see a stable search count per user per day</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">user_searches</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;id_search&#39;</span><span class="p">,</span> <span class="s1">&#39;id_user&#39;</span><span class="p">,</span> <span class="s1">&#39;ds_search&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;id_user&#39;</span><span class="p">,</span> <span class="s1">&#39;ds_search&#39;</span><span class="p">])</span>\
<span class="o">.</span><span class="n">id_search</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;id_search&#39;</span><span class="p">:</span> <span class="s1">&#39;searches_per_user&#39;</span><span class="p">})</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;ds_search&#39;</span><span class="p">)</span>\
<span class="o">.</span><span class="n">searches_per_user</span>

<span class="n">user_searches</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>count</th>
      <th>mean</th>
      <th>std</th>
      <th>min</th>
      <th>25%</th>
      <th>50%</th>
      <th>75%</th>
      <th>max</th>
    </tr>
    <tr>
      <th>ds_search</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>11/20/18</th>
      <td>869.0</td>
      <td>10.698504</td>
      <td>11.633468</td>
      <td>1.0</td>
      <td>3.0</td>
      <td>7.0</td>
      <td>14.0</td>
      <td>94.0</td>
    </tr>
    <tr>
      <th>11/21/18</th>
      <td>965.0</td>
      <td>10.222798</td>
      <td>10.957344</td>
      <td>1.0</td>
      <td>3.0</td>
      <td>7.0</td>
      <td>14.0</td>
      <td>101.0</td>
    </tr>
    <tr>
      <th>11/22/18</th>
      <td>958.0</td>
      <td>10.515658</td>
      <td>11.095447</td>
      <td>1.0</td>
      <td>3.0</td>
      <td>7.0</td>
      <td>14.0</td>
      <td>79.0</td>
    </tr>
    <tr>
      <th>11/23/18</th>
      <td>927.0</td>
      <td>9.804746</td>
      <td>9.719703</td>
      <td>1.0</td>
      <td>3.0</td>
      <td>7.0</td>
      <td>14.0</td>
      <td>75.0</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">user_searches</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">bins</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">21</span><span class="p">),</span> <span class="n">histtype</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=.</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="output_area highlight-none notranslate"><div class="highlight"><pre>
<span></span>ds_search
11/20/18    AxesSubplot(0.125,0.125;0.775x0.755)
11/21/18    AxesSubplot(0.125,0.125;0.775x0.755)
11/22/18    AxesSubplot(0.125,0.125;0.775x0.755)
11/23/18    AxesSubplot(0.125,0.125;0.775x0.755)
Name: searches_per_user, dtype: object
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/ranking_search_31_1.png" src="_images/ranking_search_31_1.png" />
</div>
</div>
</div>
</div>
<div class="section" id="Modeling">
<h2>Modeling<a class="headerlink" href="#Modeling" title="Permalink to this headline">¶</a></h2>
<div class="section" id="Baseline">
<h3>Baseline<a class="headerlink" href="#Baseline" title="Permalink to this headline">¶</a></h3>
<p>In this section I’ll begin with a raw inspection of fields to make sure that a baseline model is not suffering from any leakage and evaluate before moving on to more in depth data inspection and feature engineering</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id_search</th>
      <th>label</th>
      <th>id_user</th>
      <th>id_listing</th>
      <th>ts_search</th>
      <th>ds_search</th>
      <th>ds_book</th>
      <th>ds_contact</th>
      <th>query_market</th>
      <th>query_checkin</th>
      <th>query_checkout</th>
      <th>query_num_guests</th>
      <th>query_num_children</th>
      <th>query_num_infants</th>
      <th>query_radius</th>
      <th>query_price_max</th>
      <th>query_price_min</th>
      <th>query_center_lat</th>
      <th>query_center_lng</th>
      <th>listing_is_new</th>
      <th>listing_total_price</th>
      <th>listing_instant_bookable</th>
      <th>listing_lat</th>
      <th>listing_lng</th>
      <th>listing_review_rating</th>
      <th>listing_review_count</th>
      <th>listing_property_type</th>
      <th>listing_room_type</th>
      <th>listing_num_beds</th>
      <th>listing_num_bedrooms</th>
      <th>listing_num_bathrooms</th>
      <th>listing_person_capacity</th>
      <th>listing_has_pro_pictures</th>
      <th>listing_num_recent_reservations</th>
      <th>listing_location_rating</th>
      <th>listing_cleanliness_rating</th>
      <th>listing_checkin_rating</th>
      <th>listing_value_rating</th>
      <th>listing_communication_rating</th>
      <th>listing_accuracy_rating</th>
      <th>listing_num_books_90day</th>
      <th>listing_occupancy_rate</th>
      <th>listing_monthly_discount</th>
      <th>listing_weekly_discount</th>
      <th>listing_cleaning_fee</th>
      <th>listing_monthly_price_factor</th>
      <th>listing_weekly_price_factor</th>
      <th>listing_minimum_nights</th>
      <th>listing_maximum_nights</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>25</th>
      <td>c197cac4-4d3e-4644-837d-b8664bcf9a35</td>
      <td>impression</td>
      <td>f9d0b13bfe4dc6a76862b4884f1c08e6</td>
      <td>350f0b56db405ba2bd6625ee27ed93bb</td>
      <td>1542981540000000000</td>
      <td>11/23/18</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>Sao Paulo</td>
      <td>11/27/18</td>
      <td>11/30/18</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0.860144</td>
      <td>-1.0</td>
      <td>-1</td>
      <td>-23.59</td>
      <td>-46.68</td>
      <td>1</td>
      <td>300.00000</td>
      <td>False</td>
      <td>-23.58</td>
      <td>-46.67</td>
      <td>0.000000</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>Private Room</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>1</td>
      <td>2</td>
      <td>NaN</td>
      <td>0</td>
      <td>-1.000000</td>
      <td>-1.000000</td>
      <td>-1.000000</td>
      <td>-1.000000</td>
      <td>-1.000000</td>
      <td>-1.000000</td>
      <td>0.0</td>
      <td>0.000000</td>
      <td>0</td>
      <td>0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1.0</td>
      <td>1125.0</td>
    </tr>
    <tr>
      <th>26</th>
      <td>073080bb-8453-4c62-b679-8c48dd070dec</td>
      <td>click</td>
      <td>f9d0b13bfe4dc6a76862b4884f1c08e6</td>
      <td>19cacd588e89c13d513ed7771484d43e</td>
      <td>1542840540000000000</td>
      <td>11/21/18</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>Sao Paulo</td>
      <td>11/28/18</td>
      <td>11/30/18</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0.479950</td>
      <td>220.0</td>
      <td>0</td>
      <td>-23.59</td>
      <td>-46.68</td>
      <td>0</td>
      <td>143.71162</td>
      <td>False</td>
      <td>-23.59</td>
      <td>-46.68</td>
      <td>4.000000</td>
      <td>3.0</td>
      <td>47.0</td>
      <td>Entire Home</td>
      <td>3.0</td>
      <td>2.0</td>
      <td>1</td>
      <td>4</td>
      <td>False</td>
      <td>0</td>
      <td>5.000000</td>
      <td>4.000000</td>
      <td>5.000000</td>
      <td>4.333334</td>
      <td>5.000000</td>
      <td>5.000000</td>
      <td>1.0</td>
      <td>NaN</td>
      <td>0</td>
      <td>0</td>
      <td>39.919950</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>2.0</td>
      <td>1125.0</td>
    </tr>
    <tr>
      <th>27</th>
      <td>f83903b1-7b0f-4234-b516-b4b15f3f57e9</td>
      <td>book</td>
      <td>f9d0b13bfe4dc6a76862b4884f1c08e6</td>
      <td>714dcf2e4f64324b4a48942ca3f14745</td>
      <td>1542983340000000000</td>
      <td>11/23/18</td>
      <td>11/23/18</td>
      <td>11/23/18</td>
      <td>Sao Paulo</td>
      <td>11/27/18</td>
      <td>11/30/18</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0.729681</td>
      <td>140.0</td>
      <td>0</td>
      <td>-23.59</td>
      <td>-46.68</td>
      <td>0</td>
      <td>201.31122</td>
      <td>False</td>
      <td>-23.58</td>
      <td>-46.67</td>
      <td>4.666666</td>
      <td>18.0</td>
      <td>47.0</td>
      <td>Entire Home</td>
      <td>2.0</td>
      <td>1.0</td>
      <td>NaN</td>
      <td>3</td>
      <td>NaN</td>
      <td>0</td>
      <td>4.944445</td>
      <td>4.944445</td>
      <td>4.888889</td>
      <td>4.500000</td>
      <td>4.888889</td>
      <td>4.777778</td>
      <td>22.0</td>
      <td>0.727273</td>
      <td>1</td>
      <td>1</td>
      <td>13.149002</td>
      <td>0.8</td>
      <td>0.95</td>
      <td>1.0</td>
      <td>89.0</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">df</span><span class="o">.</span><span class="n">dtypes</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id_search</th>
      <th>label</th>
      <th>id_user</th>
      <th>id_listing</th>
      <th>ts_search</th>
      <th>ds_search</th>
      <th>ds_book</th>
      <th>ds_contact</th>
      <th>query_market</th>
      <th>query_checkin</th>
      <th>query_checkout</th>
      <th>query_num_guests</th>
      <th>query_num_children</th>
      <th>query_num_infants</th>
      <th>query_radius</th>
      <th>query_price_max</th>
      <th>query_price_min</th>
      <th>query_center_lat</th>
      <th>query_center_lng</th>
      <th>listing_is_new</th>
      <th>listing_total_price</th>
      <th>listing_instant_bookable</th>
      <th>listing_lat</th>
      <th>listing_lng</th>
      <th>listing_review_rating</th>
      <th>listing_review_count</th>
      <th>listing_property_type</th>
      <th>listing_room_type</th>
      <th>listing_num_beds</th>
      <th>listing_num_bedrooms</th>
      <th>listing_num_bathrooms</th>
      <th>listing_person_capacity</th>
      <th>listing_has_pro_pictures</th>
      <th>listing_num_recent_reservations</th>
      <th>listing_location_rating</th>
      <th>listing_cleanliness_rating</th>
      <th>listing_checkin_rating</th>
      <th>listing_value_rating</th>
      <th>listing_communication_rating</th>
      <th>listing_accuracy_rating</th>
      <th>listing_num_books_90day</th>
      <th>listing_occupancy_rate</th>
      <th>listing_monthly_discount</th>
      <th>listing_weekly_discount</th>
      <th>listing_cleaning_fee</th>
      <th>listing_monthly_price_factor</th>
      <th>listing_weekly_price_factor</th>
      <th>listing_minimum_nights</th>
      <th>listing_maximum_nights</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>object</td>
      <td>object</td>
      <td>object</td>
      <td>object</td>
      <td>int64</td>
      <td>object</td>
      <td>object</td>
      <td>object</td>
      <td>object</td>
      <td>object</td>
      <td>object</td>
      <td>int64</td>
      <td>int64</td>
      <td>int64</td>
      <td>float64</td>
      <td>float64</td>
      <td>int64</td>
      <td>float64</td>
      <td>float64</td>
      <td>int64</td>
      <td>float64</td>
      <td>bool</td>
      <td>float64</td>
      <td>float64</td>
      <td>float64</td>
      <td>float64</td>
      <td>float64</td>
      <td>object</td>
      <td>float64</td>
      <td>float64</td>
      <td>object</td>
      <td>int64</td>
      <td>object</td>
      <td>int64</td>
      <td>float64</td>
      <td>float64</td>
      <td>float64</td>
      <td>float64</td>
      <td>float64</td>
      <td>float64</td>
      <td>float64</td>
      <td>float64</td>
      <td>int64</td>
      <td>int64</td>
      <td>float64</td>
      <td>object</td>
      <td>float64</td>
      <td>float64</td>
      <td>float64</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
</div>
<div class="section" id="Recasting">
<h3>Recasting<a class="headerlink" href="#Recasting" title="Permalink to this headline">¶</a></h3>
<p>A few fields need to be recast, this is most likely incorrect type inference in pandas’ reader in combination with None / Null values that do not register as NaN</p>
<ol class="arabic simple">
<li>listing_num_bathrooms</li>
<li>listing_monthly_price_factor</li>
</ol>
<p>Note - listing_has_pro_pictures - technically bool - we can either convert None to False or treat it as a third category</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">safe_float</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="n">df</span><span class="p">,</span> <span class="n">validation_df</span><span class="p">,</span> <span class="n">holdout_df</span><span class="p">]:</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;listing_num_bathrooms&#39;</span><span class="p">,</span> <span class="s1">&#39;listing_monthly_price_factor&#39;</span><span class="p">]</span>
    <span class="k">print</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="n">columns</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
    <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
        <span class="n">i</span><span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">safe_float</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="n">columns</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
    <span class="k">print</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="n">columns</span><span class="p">]</span><span class="o">.</span><span class="n">dtypes</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="o">*</span> <span class="mi">10</span><span class="p">)</span>

    <span class="c1"># convert to timestamps</span>
    <span class="n">i</span><span class="p">[</span><span class="s1">&#39;query_checkout&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">query_checkout</span><span class="p">)</span>
    <span class="n">i</span><span class="p">[</span><span class="s1">&#39;query_checkin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">query_checkin</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
listing_num_bathrooms           0.051849
listing_monthly_price_factor    0.264948
dtype: float64
listing_num_bathrooms           0.051849
listing_monthly_price_factor    0.264948
dtype: float64
listing_num_bathrooms           float64
listing_monthly_price_factor    float64
dtype: object
**********
listing_num_bathrooms           0.050712
listing_monthly_price_factor    0.254421
dtype: float64
listing_num_bathrooms           0.050746
listing_monthly_price_factor    0.254456
dtype: float64
listing_num_bathrooms           float64
listing_monthly_price_factor    float64
dtype: object
**********
listing_num_bathrooms           0.050999
listing_monthly_price_factor    0.262019
dtype: float64
listing_num_bathrooms           0.050999
listing_monthly_price_factor    0.262019
dtype: float64
listing_num_bathrooms           float64
listing_monthly_price_factor    float64
dtype: object
**********
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">numeric</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">)</span>
<span class="n">numeric</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ts_search</th>
      <th>query_num_guests</th>
      <th>query_num_children</th>
      <th>query_num_infants</th>
      <th>query_radius</th>
      <th>query_price_max</th>
      <th>query_price_min</th>
      <th>query_center_lat</th>
      <th>query_center_lng</th>
      <th>listing_is_new</th>
      <th>listing_total_price</th>
      <th>listing_lat</th>
      <th>listing_lng</th>
      <th>listing_review_rating</th>
      <th>listing_review_count</th>
      <th>listing_property_type</th>
      <th>listing_num_beds</th>
      <th>listing_num_bedrooms</th>
      <th>listing_num_bathrooms</th>
      <th>listing_person_capacity</th>
      <th>listing_num_recent_reservations</th>
      <th>listing_location_rating</th>
      <th>listing_cleanliness_rating</th>
      <th>listing_checkin_rating</th>
      <th>listing_value_rating</th>
      <th>listing_communication_rating</th>
      <th>listing_accuracy_rating</th>
      <th>listing_num_books_90day</th>
      <th>listing_occupancy_rate</th>
      <th>listing_monthly_discount</th>
      <th>listing_weekly_discount</th>
      <th>listing_cleaning_fee</th>
      <th>listing_monthly_price_factor</th>
      <th>listing_weekly_price_factor</th>
      <th>listing_minimum_nights</th>
      <th>listing_maximum_nights</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>25</th>
      <td>1542981540000000000</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0.860144</td>
      <td>-1.0</td>
      <td>-1</td>
      <td>-23.59</td>
      <td>-46.68</td>
      <td>1</td>
      <td>300.00000</td>
      <td>-23.58</td>
      <td>-46.67</td>
      <td>0.000000</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>2</td>
      <td>0</td>
      <td>-1.000000</td>
      <td>-1.000000</td>
      <td>-1.000000</td>
      <td>-1.000000</td>
      <td>-1.000000</td>
      <td>-1.000000</td>
      <td>0.0</td>
      <td>0.000000</td>
      <td>0</td>
      <td>0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1.0</td>
      <td>1125.0</td>
    </tr>
    <tr>
      <th>26</th>
      <td>1542840540000000000</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0.479950</td>
      <td>220.0</td>
      <td>0</td>
      <td>-23.59</td>
      <td>-46.68</td>
      <td>0</td>
      <td>143.71162</td>
      <td>-23.59</td>
      <td>-46.68</td>
      <td>4.000000</td>
      <td>3.0</td>
      <td>47.0</td>
      <td>3.0</td>
      <td>2.0</td>
      <td>1.0</td>
      <td>4</td>
      <td>0</td>
      <td>5.000000</td>
      <td>4.000000</td>
      <td>5.000000</td>
      <td>4.333334</td>
      <td>5.000000</td>
      <td>5.000000</td>
      <td>1.0</td>
      <td>NaN</td>
      <td>0</td>
      <td>0</td>
      <td>39.919950</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>2.0</td>
      <td>1125.0</td>
    </tr>
    <tr>
      <th>27</th>
      <td>1542983340000000000</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0.729681</td>
      <td>140.0</td>
      <td>0</td>
      <td>-23.59</td>
      <td>-46.68</td>
      <td>0</td>
      <td>201.31122</td>
      <td>-23.58</td>
      <td>-46.67</td>
      <td>4.666666</td>
      <td>18.0</td>
      <td>47.0</td>
      <td>2.0</td>
      <td>1.0</td>
      <td>NaN</td>
      <td>3</td>
      <td>0</td>
      <td>4.944445</td>
      <td>4.944445</td>
      <td>4.888889</td>
      <td>4.500000</td>
      <td>4.888889</td>
      <td>4.777778</td>
      <td>22.0</td>
      <td>0.727273</td>
      <td>1</td>
      <td>1</td>
      <td>13.149002</td>
      <td>0.8</td>
      <td>0.95</td>
      <td>1.0</td>
      <td>89.0</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>Treatments for nulls is a critical component of model development, but to close the loop for a first baseline glm I’ll impute the mean. Subsequent work on mean vs specific value filling vs other treatments to come in subsequent steps.</p>
</div>
<div class="section" id="Donatello">
<h3>Donatello<a class="headerlink" href="#Donatello" title="Permalink to this headline">¶</a></h3>
<p>Donatello is a personal project of mine. It’s still in development, but for currently supported use cases it can be a helpful tool for building and evaluating the scoring components of ML systems. Here I’ll use it to a build scorer for the likelihood of a given impression converting to a booking. Some of it’s advantages include traceability and reproducibility, a transformation graph, and terse access to a variety of cross validation and metric evaluation strategies. Some of it’s disadvantages
include runtime speeds (parallelization is not fully supported yet) which can couple with unintentionally building lots of models (due to nesting grid search folds within cross val folds for metric estimates if those flags are activated), and weak (but growing!) test coverage. Given more time or with existing infrastructue I’d certainly make strong considerations for using other tools or building more from scratch.</p>
<p>NOTE: If it’d be helpful for interview-evaluation purposes to see any of the model development code built out from scratch, just let me know and I’d be happy to, thanks!</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">roc_auc_score</span><span class="p">,</span> <span class="n">average_precision_score</span>

<span class="kn">from</span> <span class="nn">donatello.components</span> <span class="kn">import</span> <span class="n">core</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">estimator</span><span class="p">,</span> <span class="n">transformers</span><span class="p">,</span> <span class="n">measure</span>
<span class="kn">from</span> <span class="nn">donatello.utils</span> <span class="kn">import</span> <span class="n">helpers</span>

<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">DeprecationWarning</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">load_model</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">LogisticRegression</span><span class="p">()):</span>

    <span class="n">graph</span> <span class="o">=</span> <span class="n">transformers</span><span class="o">.</span><span class="n">ModelDAG</span><span class="p">(</span><span class="nb">set</span><span class="p">([]),</span> <span class="p">{},</span> <span class="n">graphKwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;airbnb_recommendation&#39;</span><span class="p">})</span>

    <span class="n">n1</span> <span class="o">=</span> <span class="n">transformers</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="s1">&#39;select&#39;</span><span class="p">,</span> <span class="n">transformer</span><span class="o">=</span><span class="n">transformers</span><span class="o">.</span><span class="n">DatasetFlow</span><span class="p">(</span><span class="n">selectValue</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;include&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">]},</span>
                                                                          <span class="n">selectMethod</span><span class="o">=</span><span class="s1">&#39;data_type&#39;</span><span class="p">))</span>

    <span class="n">n2</span> <span class="o">=</span> <span class="n">transformers</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="s1">&#39;impute&#39;</span><span class="p">,</span> <span class="n">transformer</span><span class="o">=</span><span class="n">transformers</span><span class="o">.</span><span class="n">Imputer</span><span class="p">(),</span> <span class="n">enforceTarget</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">n3</span> <span class="o">=</span> <span class="n">transformers</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="s1">&#39;scale&#39;</span><span class="p">,</span> <span class="n">transformer</span><span class="o">=</span><span class="n">transformers</span><span class="o">.</span><span class="n">StandardScaler</span><span class="p">(),</span> <span class="n">enforceTarget</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">n4</span> <span class="o">=</span> <span class="n">transformers</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="s1">&#39;ml&#39;</span><span class="p">,</span> <span class="n">transformer</span><span class="o">=</span><span class="n">model</span><span class="p">)</span>

    <span class="n">graph</span><span class="o">.</span><span class="n">add_edge_flow</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">)</span>
    <span class="n">graph</span><span class="o">.</span><span class="n">add_edge_flow</span><span class="p">(</span><span class="n">n2</span><span class="p">,</span> <span class="n">n3</span><span class="p">)</span>
    <span class="n">graph</span><span class="o">.</span><span class="n">add_edge_flow</span><span class="p">(</span><span class="n">n3</span><span class="p">,</span> <span class="n">n4</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">graph</span>


<span class="k">def</span> <span class="nf">load_sculpture</span><span class="p">(</span><span class="n">df</span><span class="p">,</span>
                   <span class="n">outsideDf</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                   <span class="n">model</span><span class="o">=</span><span class="n">load_model</span><span class="p">(),</span>
                   <span class="n">paramGrid</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;model__ml__C&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">))},</span>
                   <span class="n">searchKwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;scoring&#39;</span><span class="p">:</span> <span class="s1">&#39;roc_auc&#39;</span><span class="p">,</span> <span class="s1">&#39;cv&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;n_jobs&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span>
                   <span class="n">weights</span><span class="o">=</span><span class="s1">&#39;coefficients&#39;</span><span class="p">,</span>
                   <span class="n">validation</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                   <span class="n">holdout</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                   <span class="n">entire</span><span class="o">=</span><span class="s1">&#39;search&#39;</span>
                  <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Helper function to load core modeling object</span>

<span class="sd">    validation, holdout, and entire can be passed a bool for as to whether to run the block,</span>
<span class="sd">    or the string &#39;search&#39; to run it with grid searching on (if a paramGrid is passed as well)</span>
<span class="sd">    Args:</span>
<span class="sd">        df (pd.DataFrame): Full training dataset</span>
<span class="sd">        outsideData (pd.DataFrame): a hold out set only for evaluation purposes</span>
<span class="sd">        model (sklearn.BaseEstimator): uphold sklearn contracts of base + fit / predict(_proba) decision_function</span>
<span class="sd">        paramGrid (dict): optional - configuration of parameter grid to search for hyperparameter tuning</span>
<span class="sd">        searchKwargs(dict): optional - configuration for sklearn.model_selection.gridSearchCV</span>
<span class="sd">        validation (bool|str): option to execute nested cross validation block and whether to tune inside</span>
<span class="sd">        validation (bool|str): option to fit on entier passed in dataset</span>
<span class="sd">        holdout (bool|str): option to fit excute internal split on train and evaluation on test</span>
<span class="sd">        entire (bool|str): option to fit on the entire passed in dataset\</span>
<span class="sd">            (assumes a heldout exists elsewhere or is integrated via outsideData)</span>


<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;is_booked&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;book&#39;</span>

    <span class="c1"># partition over user_ids -&gt; all searches associated with given user will be in same subset</span>
    <span class="c1"># within cross val measurements (and within the sub cross validation parameter tuning folds if applicable)</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">raw</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="s1">&#39;is_booked&#39;</span><span class="p">,</span> <span class="n">clay</span><span class="o">=</span><span class="s1">&#39;group&#39;</span><span class="p">,</span> <span class="n">groupDap</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;attrPath&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;id_user&#39;</span><span class="p">]})</span>

    <span class="n">est</span> <span class="o">=</span> <span class="n">estimator</span><span class="o">.</span><span class="n">Estimator</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                              <span class="n">paramGrid</span><span class="o">=</span><span class="n">paramGrid</span><span class="p">,</span>
                              <span class="n">searchKwargs</span><span class="o">=</span><span class="n">searchKwargs</span><span class="p">,</span>
                              <span class="n">method</span><span class="o">=</span><span class="s1">&#39;predict_proba&#39;</span><span class="p">,</span>
                              <span class="n">scorer</span><span class="o">=</span><span class="s1">&#39;score_second&#39;</span>
                              <span class="p">)</span>

    <span class="c1"># Produce scalar and vector binary classification metrics on test set (heldout) data</span>
    <span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span><span class="n">measure</span><span class="o">.</span><span class="n">Metric</span><span class="p">(</span><span class="n">roc_auc_score</span><span class="p">),</span> <span class="n">measure</span><span class="o">.</span><span class="n">Metric</span><span class="p">(</span><span class="n">average_precision_score</span><span class="p">),</span>
               <span class="n">measure</span><span class="o">.</span><span class="n">FeatureWeights</span><span class="p">(</span><span class="n">sort</span><span class="o">=</span><span class="n">weights</span><span class="p">),</span> <span class="n">measure</span><span class="o">.</span><span class="n">ThresholdRates</span><span class="p">()]</span>

    <span class="k">if</span> <span class="n">outsideDf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">outsideDf</span> <span class="o">=</span> <span class="n">outsideDf</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">outsideDf</span><span class="p">[</span><span class="s1">&#39;is_booked&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">outsideDf</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;book&#39;</span>

        <span class="n">outsideData</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">raw</span><span class="o">=</span><span class="n">outsideDf</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="s1">&#39;is_booked&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">outsideData</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="n">sculpture</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">Sculpture</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="n">dataset</span><span class="p">,</span> <span class="n">estimator</span><span class="o">=</span><span class="n">est</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="n">metrics</span><span class="p">,</span>
                               <span class="n">validation</span><span class="o">=</span><span class="n">validation</span><span class="p">,</span> <span class="n">holdout</span><span class="o">=</span><span class="n">holdout</span><span class="p">,</span> <span class="n">entire</span><span class="o">=</span><span class="n">entire</span><span class="p">,</span>
                               <span class="n">outsideData</span><span class="o">=</span><span class="n">outsideData</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">sculpture</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">s</span> <span class="o">=</span> <span class="n">load_sculpture</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">outsideDf</span><span class="o">=</span><span class="n">validation_df</span><span class="p">,</span>
                   <span class="n">model</span><span class="o">=</span><span class="n">load_model</span><span class="p">(),</span>
                   <span class="n">validation</span><span class="o">=</span><span class="s1">&#39;search&#39;</span><span class="p">,</span> <span class="n">holdout</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">entire</span><span class="o">=</span><span class="s1">&#39;search&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">s</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="c1"># stdout prints what dataset is being fit and whether</span>
<span class="c1"># or not a grid search is being executed on (the/a subset of) data</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Cross Validation
grid searching
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
//anaconda/lib/python2.7/site-packages/sklearn/linear_model/logistic.py:433: FutureWarning: Default solver will be changed to &#39;lbfgs&#39; in 0.22. Specify a solver to silence this warning.
  FutureWarning)
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
grid searching
grid searching
grid searching
grid searching
Entire Dataset
grid searching
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="output_area highlight-none notranslate"><div class="highlight"><pre>
<span></span>Sculpture_2019_05_28_08_17
</pre></div>
</div>
</div>
</div>
<div class="section" id="Cross-validation-metrics">
<h3>Cross validation metrics<a class="headerlink" href="#Cross-validation-metrics" title="Permalink to this headline">¶</a></h3>
<p>Measures from k fold cross val sets within the training set</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">cat</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">suffixes</span><span class="p">):</span>
    <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">arg</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">arg</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">suffix</span><span class="p">]))</span> <span class="k">for</span> <span class="n">arg</span><span class="p">,</span> <span class="n">suffix</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">args</span><span class="p">,</span><span class="n">suffixes</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[29]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">cat</span><span class="p">([</span><span class="n">helpers</span><span class="o">.</span><span class="n">view_sk_metric</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">measurements</span><span class="o">.</span><span class="n">crossValidation</span><span class="o">.</span><span class="n">roc_auc_score</span><span class="p">),</span>
    <span class="n">helpers</span><span class="o">.</span><span class="n">view_sk_metric</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">measurements</span><span class="o">.</span><span class="n">outside</span><span class="o">.</span><span class="n">roc_auc_score</span><span class="p">)],</span> <span class="p">[</span><span class="s1">&#39;validation&#39;</span><span class="p">,</span> <span class="s1">&#39;outside&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[29]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>score_validation</th>
      <th>score_outside</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>mean</th>
      <td>0.649347</td>
      <td>0.637202</td>
    </tr>
    <tr>
      <th>std</th>
      <td>0.012635</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[30]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">cat</span><span class="p">([</span><span class="n">helpers</span><span class="o">.</span><span class="n">view_sk_metric</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">measurements</span><span class="o">.</span><span class="n">crossValidation</span><span class="o">.</span><span class="n">average_precision_score</span><span class="p">),</span>
    <span class="n">helpers</span><span class="o">.</span><span class="n">view_sk_metric</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">measurements</span><span class="o">.</span><span class="n">outside</span><span class="o">.</span><span class="n">average_precision_score</span><span class="p">)],</span> <span class="p">[</span><span class="s1">&#39;validation&#39;</span><span class="p">,</span> <span class="s1">&#39;outside&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[30]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>score_validation</th>
      <th>score_outside</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>mean</th>
      <td>0.021143</td>
      <td>0.019599</td>
    </tr>
    <tr>
      <th>std</th>
      <td>0.001732</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[31]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">s</span><span class="o">.</span><span class="n">measurements</span><span class="o">.</span><span class="n">outside</span><span class="o">.</span><span class="n">feature_weights</span><span class="o">.</span><span class="n">mean</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[31]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>coefficients</th>
    </tr>
    <tr>
      <th>names</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>intercept_</th>
      <td>-4.656154</td>
    </tr>
    <tr>
      <th>listing_lat</th>
      <td>-1.068169</td>
    </tr>
    <tr>
      <th>listing_total_price</th>
      <td>-0.840368</td>
    </tr>
    <tr>
      <th>query_radius</th>
      <td>-0.764321</td>
    </tr>
    <tr>
      <th>listing_cleanliness_rating</th>
      <td>-0.325310</td>
    </tr>
    <tr>
      <th>listing_maximum_nights</th>
      <td>-0.265827</td>
    </tr>
    <tr>
      <th>query_center_lng</th>
      <td>-0.256836</td>
    </tr>
    <tr>
      <th>listing_checkin_rating</th>
      <td>-0.226505</td>
    </tr>
    <tr>
      <th>listing_communication_rating</th>
      <td>-0.223060</td>
    </tr>
    <tr>
      <th>listing_person_capacity</th>
      <td>-0.098476</td>
    </tr>
    <tr>
      <th>query_price_max</th>
      <td>-0.066346</td>
    </tr>
    <tr>
      <th>listing_weekly_discount</th>
      <td>-0.057077</td>
    </tr>
    <tr>
      <th>listing_num_beds</th>
      <td>-0.043192</td>
    </tr>
    <tr>
      <th>listing_monthly_price_factor</th>
      <td>-0.040072</td>
    </tr>
    <tr>
      <th>listing_num_recent_reservations</th>
      <td>-0.016518</td>
    </tr>
    <tr>
      <th>listing_weekly_price_factor</th>
      <td>-0.016480</td>
    </tr>
    <tr>
      <th>listing_is_new</th>
      <td>-0.009894</td>
    </tr>
    <tr>
      <th>listing_cleaning_fee</th>
      <td>0.004867</td>
    </tr>
    <tr>
      <th>query_num_guests</th>
      <td>0.012240</td>
    </tr>
    <tr>
      <th>listing_property_type</th>
      <td>0.023704</td>
    </tr>
    <tr>
      <th>listing_minimum_nights</th>
      <td>0.030747</td>
    </tr>
    <tr>
      <th>listing_location_rating</th>
      <td>0.033386</td>
    </tr>
    <tr>
      <th>listing_review_count</th>
      <td>0.033650</td>
    </tr>
    <tr>
      <th>listing_monthly_discount</th>
      <td>0.036707</td>
    </tr>
    <tr>
      <th>query_num_infants</th>
      <td>0.037815</td>
    </tr>
    <tr>
      <th>listing_review_rating</th>
      <td>0.042164</td>
    </tr>
    <tr>
      <th>query_num_children</th>
      <td>0.046761</td>
    </tr>
    <tr>
      <th>query_price_min</th>
      <td>0.071758</td>
    </tr>
    <tr>
      <th>listing_num_bedrooms</th>
      <td>0.077212</td>
    </tr>
    <tr>
      <th>ts_search</th>
      <td>0.085890</td>
    </tr>
    <tr>
      <th>listing_num_bathrooms</th>
      <td>0.088011</td>
    </tr>
    <tr>
      <th>listing_num_books_90day</th>
      <td>0.103663</td>
    </tr>
    <tr>
      <th>query_center_lat</th>
      <td>0.121089</td>
    </tr>
    <tr>
      <th>listing_value_rating</th>
      <td>0.232670</td>
    </tr>
    <tr>
      <th>listing_occupancy_rate</th>
      <td>0.306391</td>
    </tr>
    <tr>
      <th>listing_accuracy_rating</th>
      <td>0.558430</td>
    </tr>
    <tr>
      <th>listing_lng</th>
      <td>0.585841</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span>
</pre></div>
</div>
</div>
<p>We have a <code class="docutils literal notranslate"><span class="pre">slightly</span></code> better than random scoring of impressions to bookings. Next we’ll look at the relative impact of features via the coefficients of the Logistic Regression (note coefficients reflect the scaled data) before closing the loop on setting a baseline gain with which to compare against</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[32]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">s</span><span class="o">.</span><span class="n">measurements</span><span class="o">.</span><span class="n">outside</span><span class="o">.</span><span class="n">feature_weights</span><span class="o">.</span><span class="n">mean</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[32]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>coefficients</th>
    </tr>
    <tr>
      <th>names</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>intercept_</th>
      <td>-4.656154</td>
    </tr>
    <tr>
      <th>listing_lat</th>
      <td>-1.068169</td>
    </tr>
    <tr>
      <th>listing_total_price</th>
      <td>-0.840368</td>
    </tr>
    <tr>
      <th>query_radius</th>
      <td>-0.764321</td>
    </tr>
    <tr>
      <th>listing_cleanliness_rating</th>
      <td>-0.325310</td>
    </tr>
    <tr>
      <th>listing_maximum_nights</th>
      <td>-0.265827</td>
    </tr>
    <tr>
      <th>query_center_lng</th>
      <td>-0.256836</td>
    </tr>
    <tr>
      <th>listing_checkin_rating</th>
      <td>-0.226505</td>
    </tr>
    <tr>
      <th>listing_communication_rating</th>
      <td>-0.223060</td>
    </tr>
    <tr>
      <th>listing_person_capacity</th>
      <td>-0.098476</td>
    </tr>
    <tr>
      <th>query_price_max</th>
      <td>-0.066346</td>
    </tr>
    <tr>
      <th>listing_weekly_discount</th>
      <td>-0.057077</td>
    </tr>
    <tr>
      <th>listing_num_beds</th>
      <td>-0.043192</td>
    </tr>
    <tr>
      <th>listing_monthly_price_factor</th>
      <td>-0.040072</td>
    </tr>
    <tr>
      <th>listing_num_recent_reservations</th>
      <td>-0.016518</td>
    </tr>
    <tr>
      <th>listing_weekly_price_factor</th>
      <td>-0.016480</td>
    </tr>
    <tr>
      <th>listing_is_new</th>
      <td>-0.009894</td>
    </tr>
    <tr>
      <th>listing_cleaning_fee</th>
      <td>0.004867</td>
    </tr>
    <tr>
      <th>query_num_guests</th>
      <td>0.012240</td>
    </tr>
    <tr>
      <th>listing_property_type</th>
      <td>0.023704</td>
    </tr>
    <tr>
      <th>listing_minimum_nights</th>
      <td>0.030747</td>
    </tr>
    <tr>
      <th>listing_location_rating</th>
      <td>0.033386</td>
    </tr>
    <tr>
      <th>listing_review_count</th>
      <td>0.033650</td>
    </tr>
    <tr>
      <th>listing_monthly_discount</th>
      <td>0.036707</td>
    </tr>
    <tr>
      <th>query_num_infants</th>
      <td>0.037815</td>
    </tr>
    <tr>
      <th>listing_review_rating</th>
      <td>0.042164</td>
    </tr>
    <tr>
      <th>query_num_children</th>
      <td>0.046761</td>
    </tr>
    <tr>
      <th>query_price_min</th>
      <td>0.071758</td>
    </tr>
    <tr>
      <th>listing_num_bedrooms</th>
      <td>0.077212</td>
    </tr>
    <tr>
      <th>ts_search</th>
      <td>0.085890</td>
    </tr>
    <tr>
      <th>listing_num_bathrooms</th>
      <td>0.088011</td>
    </tr>
    <tr>
      <th>listing_num_books_90day</th>
      <td>0.103663</td>
    </tr>
    <tr>
      <th>query_center_lat</th>
      <td>0.121089</td>
    </tr>
    <tr>
      <th>listing_value_rating</th>
      <td>0.232670</td>
    </tr>
    <tr>
      <th>listing_occupancy_rate</th>
      <td>0.306391</td>
    </tr>
    <tr>
      <th>listing_accuracy_rating</th>
      <td>0.558430</td>
    </tr>
    <tr>
      <th>listing_lng</th>
      <td>0.585841</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[33]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">x_mean</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">measurements</span><span class="o">.</span><span class="n">outside</span><span class="o">.</span><span class="n">ThresholdRates</span><span class="o">.</span><span class="n">mean</span><span class="o">.</span><span class="n">fall_out</span>
<span class="n">y_mean</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">measurements</span><span class="o">.</span><span class="n">outside</span><span class="o">.</span><span class="n">ThresholdRates</span><span class="o">.</span><span class="n">mean</span><span class="o">.</span><span class="n">recall</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_mean</span><span class="p">,</span> <span class="n">y_mean</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;r--&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="o">-</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">1.01</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="o">-</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">1.01</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;True Positive Rate&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;False Positive Rate&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;ROC curve&#39;</span><span class="p">)</span>

</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[33]:
</pre></div>
</div>
<div class="output_area highlight-none notranslate"><div class="highlight"><pre>
<span></span>Text(0.5,1,&#39;ROC curve&#39;)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/ranking_search_51_1.png" src="_images/ranking_search_51_1.png" />
</div>
</div>
<p>Gain - ndcg at k=10</p>
<p>Browser agent’s, device types, design choices and A/B all tests impact the manner in which listings are served. I chose k=10 because it strikes a reasonable balance covering the majority of impressions recieved and because on my current device (laptop) I see 10 listings without having to page. The manner in which different recommendations systems built from this data change relative to each other with varying k is another interesting area to explore in the future.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[34]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">ndcg_score</span><span class="p">(</span><span class="n">sculpture</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">sculpture</span><span class="o">.</span><span class="n">outsideData</span><span class="o">.</span><span class="n">designData</span> <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">df</span>
    <span class="n">scores</span> <span class="o">=</span> <span class="n">sculpture</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">df</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Estimator&#39;</span><span class="p">,</span> <span class="s1">&#39;ds_search&#39;</span><span class="p">,</span> <span class="s1">&#39;id_user&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">i</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;query&#39;</span><span class="p">))]</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;relevance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">map</span><span class="p">({</span><span class="s1">&#39;impression&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;click&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;host_contact&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;book&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">})</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="p">[</span><span class="n">columns</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;relevance&#39;</span><span class="p">]]</span> <span class="p">,</span> <span class="n">scores</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">gain</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">sub</span><span class="p">:</span> <span class="n">ndcg</span><span class="p">(</span><span class="n">sub</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="n">k</span><span class="p">)[</span><span class="s1">&#39;relevance&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                                                      <span class="n">sub</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="n">k</span><span class="p">)[</span><span class="s1">&#39;Estimator&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="k">if</span> <span class="n">sub</span><span class="o">.</span><span class="n">relevance</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="bp">None</span>
                                     <span class="p">)</span>
    <span class="k">return</span> <span class="n">gain</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[35]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">gains</span> <span class="o">=</span> <span class="n">ndcg_score</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">gains</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
<span class="n">gains</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;gain&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">bins</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/anaconda/lib/python2.7/site-packages/ipykernel_launcher.py:12: RuntimeWarning: invalid value encountered in double_scalars
  if sys.path[0] == &#39;&#39;:
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
0.799007610942
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[35]:
</pre></div>
</div>
<div class="output_area highlight-none notranslate"><div class="highlight"><pre>
<span></span>array([[&lt;matplotlib.axes._subplots.AxesSubplot object at 0x12c416790&gt;]],
      dtype=object)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/ranking_search_54_3.png" src="_images/ranking_search_54_3.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span>
</pre></div>
</div>
</div>
<div class="section" id="Feature-Engineering">
<h4>Feature Engineering<a class="headerlink" href="#Feature-Engineering" title="Permalink to this headline">¶</a></h4>
<p>Feature engineering enables us to empower our model with a better semantic understanding of the relationships bewteen the design and the target. Domain expertise and understanding of the contents of the available data is critical for feature engineering (call out to the not quite deterministic, to me, units of the <code class="docutils literal notranslate"><span class="pre">query_radius</span></code> field in this dataset). For this section I’ll focus on two areas:</p>
<ol class="arabic simple">
<li>Improving imputations. In the baseline a flat mean was imputed, count fields should likely be zeroed (or in certain cases ceiled). Imputations don’t pertain only to NULLs, the -1 in pricing bounds could imply no price bounds were set or the log was dropped.</li>
<li>Transforming existing data into a more useful form - this work can range from applying a non linear transform to a field to yield a better response from a glm to leveraging historical information to augment records</li>
</ol>
<p>To start, I’ll look at the data</p>
</div>
</div>
<div class="section" id="NULLS">
<h3>NULLS<a class="headerlink" href="#NULLS" title="Permalink to this headline">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[36]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">df</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">()</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">:</span><span class="s1">&#39;fraction_null&#39;</span><span class="p">})</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[36]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>fraction_null</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>listing_maximum_nights</th>
      <td>0.001479</td>
    </tr>
    <tr>
      <th>listing_minimum_nights</th>
      <td>0.001479</td>
    </tr>
    <tr>
      <th>listing_num_beds</th>
      <td>0.050407</td>
    </tr>
    <tr>
      <th>listing_num_bedrooms</th>
      <td>0.050664</td>
    </tr>
    <tr>
      <th>listing_property_type</th>
      <td>0.050866</td>
    </tr>
    <tr>
      <th>listing_total_price</th>
      <td>0.051270</td>
    </tr>
    <tr>
      <th>listing_num_bathrooms</th>
      <td>0.051849</td>
    </tr>
    <tr>
      <th>listing_has_pro_pictures</th>
      <td>0.053043</td>
    </tr>
    <tr>
      <th>listing_occupancy_rate</th>
      <td>0.060850</td>
    </tr>
    <tr>
      <th>listing_review_count</th>
      <td>0.098720</td>
    </tr>
    <tr>
      <th>listing_review_rating</th>
      <td>0.120571</td>
    </tr>
    <tr>
      <th>listing_num_books_90day</th>
      <td>0.139547</td>
    </tr>
    <tr>
      <th>listing_weekly_price_factor</th>
      <td>0.252879</td>
    </tr>
    <tr>
      <th>listing_cleaning_fee</th>
      <td>0.256581</td>
    </tr>
    <tr>
      <th>listing_monthly_price_factor</th>
      <td>0.264948</td>
    </tr>
    <tr>
      <th>ds_contact</th>
      <td>0.972877</td>
    </tr>
    <tr>
      <th>ds_book</th>
      <td>0.988060</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>Query data is flush, listing data could require some imputation work. The two <code class="docutils literal notranslate"><span class="pre">ds_</span></code> fields null column is a direct mapping of host contact and booking. We ignore these because we will not have them at request time (and in this case they would effectively leak the target itself into the design)</p>
</div>
<div class="section" id="Missing-value-semantic-assumptions">
<h3>Missing value semantic assumptions<a class="headerlink" href="#Missing-value-semantic-assumptions" title="Permalink to this headline">¶</a></h3>
<p>The percent of missing records associated with <code class="docutils literal notranslate"><span class="pre">_nights</span></code> is small we could drop, we could impute, the count is so low I would not expect it to be substantilly impactful unless the lack of existance correlates strongly with booking.</p>
<p>Next I’ll look at the range of few fields to try to develop some intuition about how / why some values may be missing. The difference between that data was dropped from a log or not instrumented vs NULL being an actual description of an attribute (i.e.&nbsp;if a field can be 0 but never is 0, NULL may be implicity defined as 0, which would have negative impact on the models response if the mean was imputed).</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[37]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">df</span><span class="p">[[</span><span class="s1">&#39;listing_num_bedrooms&#39;</span><span class="p">,</span> <span class="s1">&#39;listing_weekly_price_factor&#39;</span><span class="p">,</span> <span class="s1">&#39;listing_review_count&#39;</span><span class="p">,</span> <span class="s1">&#39;listing_cleaning_fee&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[37]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>listing_num_bedrooms</th>
      <th>listing_weekly_price_factor</th>
      <th>listing_review_count</th>
      <th>listing_cleaning_fee</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>103358.000000</td>
      <td>81342.000000</td>
      <td>98126.000000</td>
      <td>80939.000000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>1.480814</td>
      <td>0.916827</td>
      <td>22.172452</td>
      <td>34.104293</td>
    </tr>
    <tr>
      <th>std</th>
      <td>1.154156</td>
      <td>0.073984</td>
      <td>37.661784</td>
      <td>29.156729</td>
    </tr>
    <tr>
      <th>min</th>
      <td>0.000000</td>
      <td>0.130000</td>
      <td>0.000000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>1.000000</td>
      <td>0.890000</td>
      <td>0.000000</td>
      <td>18.542898</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>1.000000</td>
      <td>0.920000</td>
      <td>5.000000</td>
      <td>31.985073</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>2.000000</td>
      <td>0.980000</td>
      <td>27.000000</td>
      <td>42.383770</td>
    </tr>
    <tr>
      <th>max</th>
      <td>50.000000</td>
      <td>1.000000</td>
      <td>462.000000</td>
      <td>799.626830</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>Given the ranges on these numbers, I will not dig further into imputations and instead focus on other transformations. To handle these records I’ll create additional columns for the existance of a value in the field and then apply a min,max, or mean imputations applicably</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[38]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">df</span><span class="p">[[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">df</span> <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;query_&#39;</span><span class="p">)]]</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[38]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>query_market</th>
      <th>query_checkin</th>
      <th>query_checkout</th>
      <th>query_num_guests</th>
      <th>query_num_children</th>
      <th>query_num_infants</th>
      <th>query_radius</th>
      <th>query_price_max</th>
      <th>query_price_min</th>
      <th>query_center_lat</th>
      <th>query_center_lng</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>25</th>
      <td>Sao Paulo</td>
      <td>2018-11-27</td>
      <td>2018-11-30</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0.860144</td>
      <td>-1.0</td>
      <td>-1</td>
      <td>-23.59</td>
      <td>-46.68</td>
    </tr>
    <tr>
      <th>26</th>
      <td>Sao Paulo</td>
      <td>2018-11-28</td>
      <td>2018-11-30</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0.479950</td>
      <td>220.0</td>
      <td>0</td>
      <td>-23.59</td>
      <td>-46.68</td>
    </tr>
    <tr>
      <th>27</th>
      <td>Sao Paulo</td>
      <td>2018-11-27</td>
      <td>2018-11-30</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0.729681</td>
      <td>140.0</td>
      <td>0</td>
      <td>-23.59</td>
      <td>-46.68</td>
    </tr>
    <tr>
      <th>28</th>
      <td>Sao Paulo</td>
      <td>2018-11-27</td>
      <td>2018-11-30</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0.860144</td>
      <td>-1.0</td>
      <td>-1</td>
      <td>-23.59</td>
      <td>-46.68</td>
    </tr>
    <tr>
      <th>29</th>
      <td>Sao Paulo</td>
      <td>2018-11-28</td>
      <td>2018-11-30</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0.860144</td>
      <td>-1.0</td>
      <td>-1</td>
      <td>-23.59</td>
      <td>-46.68</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>Assuming price cannot be negative we’ll assume <code class="docutils literal notranslate"><span class="pre">-1</span></code> in the query conveys no bound. While the existance of 0 and -1 in the min field potenitally refutes this in the future we can compare the impact of this transformation in isolation on our system performance. To transform this data I’ll map -1 in max to the max of the column in the training set and -1 in the min to 0.</p>
<p>Location - with only two signifigant figures per degree in lat and long this data gives us slightly more information than the market field. What is relevant about these fields is the relation to what experiences / amenities lay in the area surrounding the target as well as the distance to listing. Evaluating the expected price for a listing given it’s locaiton is an interesting and important area to look at in the future when other data sources can be integrated (public transit access, safety,
amenity density / quality) we get some of that data from <code class="docutils literal notranslate"><span class="pre">listing_location_rating</span></code> but providing a collection values instead of a single scalar should benefit the model.</p>
<p>Date ranges - we can convert check in - checkout bounds into a length to convey the impact on length of the stay. (do longer stays, which cost more lead to longer searches that the user weighs more heavily?)</p>
<p>Distance - while distance calculations are negatively impacted by the number of signifigant digits in the lat/lon columns, I’ll calculate a haversine distance in km between the query center and the listing locations.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[39]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">df</span><span class="o">.</span><span class="n">query_market</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[39]:
</pre></div>
</div>
<div class="output_area highlight-none notranslate"><div class="highlight"><pre>
<span></span>array([&#39;Sao Paulo&#39;, &#39;Rio de Janeiro&#39;], dtype=object)
</pre></div>
</div>
</div>
</div>
<div class="section" id="Transforms">
<h3>Transforms<a class="headerlink" href="#Transforms" title="Permalink to this headline">¶</a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[40]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">udf_stateless</span><span class="p">(</span><span class="n">dataset</span><span class="p">):</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">designData</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;distance_km&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">haversine</span><span class="p">((</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;query_center_lat&#39;</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;query_center_lng&#39;</span><span class="p">]),</span>
                                         <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;listing_lat&#39;</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;listing_lng&#39;</span><span class="p">])</span>
                                         <span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
                     <span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1">#distance in km</span>


    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;duration_days&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">query_checkout</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="o">-</span> <span class="n">df</span><span class="o">.</span><span class="n">query_checkin</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>\
                           <span class="o">/</span> <span class="p">(</span><span class="mf">1e9</span> <span class="o">*</span> <span class="mi">3600</span> <span class="o">*</span> <span class="mi">24</span><span class="p">)</span> <span class="c1">#nsec -&gt; days</span>

    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;amortized_costs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">listing_total_price</span> <span class="o">/</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">duration_days</span> <span class="o">*</span> <span class="n">df</span><span class="o">.</span><span class="n">query_num_guests</span><span class="p">)</span>

    <span class="n">price_max</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;query_price_max&#39;</span><span class="p">]</span>
    <span class="n">price_min</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;query_price_min&#39;</span><span class="p">]</span>
    <span class="n">price_max</span> <span class="o">=</span> <span class="n">price_max</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="k">if</span> <span class="n">x</span><span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">pd</span><span class="o">.</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="n">price_min</span> <span class="o">=</span> <span class="n">price_min</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="k">if</span> <span class="n">x</span><span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">pd</span><span class="o">.</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;query_price_max&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">price_max</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;query_price_min&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">price_min</span>

    <span class="k">return</span> <span class="n">dataset</span><span class="o">.</span><span class="n">with_params</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">targetData</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[41]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">load_model_full</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">LogisticRegression</span><span class="p">(</span><span class="n">C</span><span class="o">=.</span><span class="mi">5</span><span class="p">),</span> <span class="n">dropOne</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>

    <span class="n">graph</span> <span class="o">=</span> <span class="n">transformers</span><span class="o">.</span><span class="n">ModelDAG</span><span class="p">(</span><span class="nb">set</span><span class="p">([]),</span> <span class="p">{},</span> <span class="n">graphKwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;airbnb_recommendation&#39;</span><span class="p">})</span>

    <span class="n">n00</span> <span class="o">=</span> <span class="n">transformers</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="s1">&#39;stateless&#39;</span><span class="p">,</span> <span class="n">transformers</span><span class="o">.</span><span class="n">Apply</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="n">udf_stateless</span><span class="p">))</span>

    <span class="n">n10</span> <span class="o">=</span> <span class="n">transformers</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="s1">&#39;ohe&#39;</span><span class="p">,</span> <span class="n">transformers</span><span class="o">.</span><span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">dropOne</span><span class="o">=</span><span class="n">dropOne</span><span class="p">))</span>

    <span class="c1"># adds a boolean encoded column for each column with a fraction of nulls &gt; tolerance</span>
    <span class="c1"># stores min/max from specified fields in training set and fills nulls in columns during transform</span>
    <span class="n">n20</span> <span class="o">=</span> <span class="n">transformers</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="s1">&#39;existance&#39;</span><span class="p">,</span> <span class="n">transformer</span><span class="o">=</span><span class="n">transformers</span><span class="o">.</span><span class="n">Exists</span><span class="p">(</span><span class="n">tolerance</span><span class="o">=.</span><span class="mi">2</span><span class="p">,</span>
                                                                      <span class="n">minFields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;query_price_min&#39;</span><span class="p">],</span>
                                                                      <span class="n">maxFields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;query_price_max&#39;</span><span class="p">]))</span>

    <span class="n">n21</span> <span class="o">=</span> <span class="n">transformers</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="s1">&#39;mean_impute&#39;</span><span class="p">,</span> <span class="n">transformer</span><span class="o">=</span><span class="n">transformers</span><span class="o">.</span><span class="n">Imputer</span><span class="p">(),</span> <span class="n">enforceTarget</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>


    <span class="n">n22</span> <span class="o">=</span> <span class="n">transformers</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="s1">&#39;scale&#39;</span><span class="p">,</span> <span class="n">transformer</span><span class="o">=</span><span class="n">transformers</span><span class="o">.</span><span class="n">StandardScaler</span><span class="p">(),</span> <span class="n">enforceTarget</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">n03</span> <span class="o">=</span> <span class="n">transformers</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="s1">&#39;ml&#39;</span><span class="p">,</span> <span class="n">transformer</span><span class="o">=</span><span class="n">model</span><span class="p">)</span>



    <span class="n">graph</span><span class="o">.</span><span class="n">add_edge_flow</span><span class="p">(</span><span class="n">n00</span><span class="p">,</span> <span class="n">n10</span><span class="p">,</span> <span class="n">passTarget</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">selectValue</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;listing_room_type&#39;</span><span class="p">,</span><span class="s1">&#39;listing_has_pro_pictures&#39;</span><span class="p">],</span> <span class="n">invert</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">graph</span><span class="o">.</span><span class="n">add_edge_flow</span><span class="p">(</span><span class="n">n10</span><span class="p">,</span> <span class="n">n03</span><span class="p">,</span> <span class="n">passTarget</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>


    <span class="n">graph</span><span class="o">.</span><span class="n">add_edge_flow</span><span class="p">(</span><span class="n">n00</span><span class="p">,</span> <span class="n">n20</span><span class="p">,</span> <span class="n">selectValue</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;include&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;number&#39;</span><span class="p">]},</span> <span class="n">selectMethod</span><span class="o">=</span><span class="s1">&#39;data_type&#39;</span><span class="p">,</span> <span class="n">invert</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">graph</span><span class="o">.</span><span class="n">add_edge_flow</span><span class="p">(</span><span class="n">n20</span><span class="p">,</span> <span class="n">n21</span><span class="p">)</span>
    <span class="n">graph</span><span class="o">.</span><span class="n">add_edge_flow</span><span class="p">(</span><span class="n">n21</span><span class="p">,</span> <span class="n">n22</span><span class="p">)</span>
    <span class="n">graph</span><span class="o">.</span><span class="n">add_edge_flow</span><span class="p">(</span><span class="n">n22</span><span class="p">,</span> <span class="n">n03</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">graph</span>

</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[44]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">logit</span> <span class="o">=</span> <span class="n">load_sculpture</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">outsideDf</span><span class="o">=</span><span class="n">validation_df</span><span class="p">,</span>
                       <span class="n">model</span><span class="o">=</span><span class="n">load_model_full</span><span class="p">(),</span>
                       <span class="n">validation</span><span class="o">=</span><span class="s1">&#39;search&#39;</span><span class="p">,</span> <span class="n">holdout</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">entire</span><span class="o">=</span><span class="s1">&#39;search&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[46]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">logit</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Cross Validation
grid searching
grid searching
grid searching
grid searching
grid searching
Entire Dataset
grid searching
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[46]:
</pre></div>
</div>
<div class="output_area highlight-none notranslate"><div class="highlight"><pre>
<span></span>Sculpture_2019_05_28_08_21
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[47]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">logit</span><span class="o">.</span><span class="n">estimator</span><span class="o">.</span><span class="n">gridSearch</span><span class="o">.</span><span class="n">best_params_</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[47]:
</pre></div>
</div>
<div class="output_area highlight-none notranslate"><div class="highlight"><pre>
<span></span>{&#39;model__ml__C&#39;: 10.0}
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[48]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">cat</span><span class="p">([</span><span class="n">helpers</span><span class="o">.</span><span class="n">view_sk_metric</span><span class="p">(</span><span class="n">logit</span><span class="o">.</span><span class="n">measurements</span><span class="o">.</span><span class="n">crossValidation</span><span class="o">.</span><span class="n">roc_auc_score</span><span class="p">),</span>
    <span class="n">helpers</span><span class="o">.</span><span class="n">view_sk_metric</span><span class="p">(</span><span class="n">logit</span><span class="o">.</span><span class="n">measurements</span><span class="o">.</span><span class="n">outside</span><span class="o">.</span><span class="n">roc_auc_score</span><span class="p">)],</span> <span class="p">[</span><span class="s1">&#39;validation&#39;</span><span class="p">,</span> <span class="s1">&#39;outside&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[48]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>score_validation</th>
      <th>score_outside</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>mean</th>
      <td>0.657442</td>
      <td>0.654058</td>
    </tr>
    <tr>
      <th>std</th>
      <td>0.015299</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[49]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">cat</span><span class="p">([</span><span class="n">helpers</span><span class="o">.</span><span class="n">view_sk_metric</span><span class="p">(</span><span class="n">logit</span><span class="o">.</span><span class="n">measurements</span><span class="o">.</span><span class="n">crossValidation</span><span class="o">.</span><span class="n">average_precision_score</span><span class="p">),</span>
    <span class="n">helpers</span><span class="o">.</span><span class="n">view_sk_metric</span><span class="p">(</span><span class="n">logit</span><span class="o">.</span><span class="n">measurements</span><span class="o">.</span><span class="n">outside</span><span class="o">.</span><span class="n">average_precision_score</span><span class="p">)],</span> <span class="p">[</span><span class="s1">&#39;validation&#39;</span><span class="p">,</span> <span class="s1">&#39;outside&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[49]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>score_validation</th>
      <th>score_outside</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>mean</th>
      <td>0.021029</td>
      <td>0.021257</td>
    </tr>
    <tr>
      <th>std</th>
      <td>0.001902</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[50]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">logit</span><span class="o">.</span><span class="n">measurements</span><span class="o">.</span><span class="n">outside</span><span class="o">.</span><span class="n">feature_weights</span><span class="o">.</span><span class="n">mean</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[50]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>coefficients</th>
    </tr>
    <tr>
      <th>names</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>intercept_</th>
      <td>-4.861454</td>
    </tr>
    <tr>
      <th>distance_km</th>
      <td>-3.987347</td>
    </tr>
    <tr>
      <th>listing_lat</th>
      <td>-3.059293</td>
    </tr>
    <tr>
      <th>amortized_costs</th>
      <td>-1.617258</td>
    </tr>
    <tr>
      <th>listing_total_price</th>
      <td>-0.667950</td>
    </tr>
    <tr>
      <th>listing_room_type_Shared Room</th>
      <td>-0.575123</td>
    </tr>
    <tr>
      <th>listing_cleanliness_rating</th>
      <td>-0.318860</td>
    </tr>
    <tr>
      <th>query_price_max</th>
      <td>-0.270403</td>
    </tr>
    <tr>
      <th>listing_communication_rating</th>
      <td>-0.238746</td>
    </tr>
    <tr>
      <th>listing_maximum_nights</th>
      <td>-0.226304</td>
    </tr>
    <tr>
      <th>query_radius</th>
      <td>-0.222698</td>
    </tr>
    <tr>
      <th>listing_checkin_rating</th>
      <td>-0.221558</td>
    </tr>
    <tr>
      <th>query_price_min_exists</th>
      <td>-0.124241</td>
    </tr>
    <tr>
      <th>query_price_max_exists</th>
      <td>-0.124241</td>
    </tr>
    <tr>
      <th>listing_has_pro_pictures_True</th>
      <td>-0.107204</td>
    </tr>
    <tr>
      <th>listing_weekly_discount</th>
      <td>-0.100857</td>
    </tr>
    <tr>
      <th>listing_person_capacity</th>
      <td>-0.079969</td>
    </tr>
    <tr>
      <th>listing_monthly_price_factor</th>
      <td>-0.055693</td>
    </tr>
    <tr>
      <th>listing_lng</th>
      <td>-0.052008</td>
    </tr>
    <tr>
      <th>listing_weekly_price_factor</th>
      <td>-0.045963</td>
    </tr>
    <tr>
      <th>listing_num_beds</th>
      <td>-0.045772</td>
    </tr>
    <tr>
      <th>listing_location_rating</th>
      <td>-0.037893</td>
    </tr>
    <tr>
      <th>listing_has_pro_pictures_False</th>
      <td>-0.025316</td>
    </tr>
    <tr>
      <th>listing_num_recent_reservations</th>
      <td>-0.015481</td>
    </tr>
    <tr>
      <th>listing_monthly_discount</th>
      <td>0.001912</td>
    </tr>
    <tr>
      <th>listing_cleaning_fee</th>
      <td>0.002524</td>
    </tr>
    <tr>
      <th>listing_is_new</th>
      <td>0.004898</td>
    </tr>
    <tr>
      <th>duration_days</th>
      <td>0.005007</td>
    </tr>
    <tr>
      <th>listing_minimum_nights</th>
      <td>0.017783</td>
    </tr>
    <tr>
      <th>listing_monthly_price_factor_exists</th>
      <td>0.022196</td>
    </tr>
    <tr>
      <th>query_num_guests</th>
      <td>0.024142</td>
    </tr>
    <tr>
      <th>query_num_infants</th>
      <td>0.030965</td>
    </tr>
    <tr>
      <th>query_num_children</th>
      <td>0.031777</td>
    </tr>
    <tr>
      <th>listing_review_count</th>
      <td>0.035969</td>
    </tr>
    <tr>
      <th>listing_cleaning_fee_exists</th>
      <td>0.039572</td>
    </tr>
    <tr>
      <th>listing_property_type</th>
      <td>0.041340</td>
    </tr>
    <tr>
      <th>listing_review_rating</th>
      <td>0.041723</td>
    </tr>
    <tr>
      <th>listing_room_type_Entire Home</th>
      <td>0.056368</td>
    </tr>
    <tr>
      <th>listing_weekly_price_factor_exists</th>
      <td>0.059205</td>
    </tr>
    <tr>
      <th>listing_num_bedrooms</th>
      <td>0.074299</td>
    </tr>
    <tr>
      <th>ts_search</th>
      <td>0.079526</td>
    </tr>
    <tr>
      <th>query_price_min</th>
      <td>0.079901</td>
    </tr>
    <tr>
      <th>listing_num_books_90day</th>
      <td>0.106744</td>
    </tr>
    <tr>
      <th>listing_num_bathrooms</th>
      <td>0.112561</td>
    </tr>
    <tr>
      <th>listing_occupancy_rate</th>
      <td>0.280967</td>
    </tr>
    <tr>
      <th>listing_value_rating</th>
      <td>0.287678</td>
    </tr>
    <tr>
      <th>query_center_lng</th>
      <td>0.360087</td>
    </tr>
    <tr>
      <th>listing_accuracy_rating</th>
      <td>0.567824</td>
    </tr>
    <tr>
      <th>query_center_lat</th>
      <td>1.058829</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span>
</pre></div>
</div>
</div>
<p>Two important area that I haven’t looked at yet is nonlinear transform of the feature data to transfrom it into a linear space and the interactions between the features themselves. Rather than building these by hand I’ll look to a non parametric model to give the same information with less effort to classify bookings.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[69]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestClassifier</span>

<span class="n">rf</span> <span class="o">=</span> <span class="n">load_sculpture</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">outsideDf</span><span class="o">=</span><span class="n">validation_df</span><span class="p">,</span>
                   <span class="n">weights</span><span class="o">=</span><span class="s1">&#39;feature_importances&#39;</span><span class="p">,</span>
                   <span class="n">model</span><span class="o">=</span><span class="n">load_model_full</span><span class="p">(</span><span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">min_samples_split</span><span class="o">=</span><span class="mi">250</span><span class="p">)),</span>
                   <span class="n">paramGrid</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;model__ml__max_depth&#39;</span><span class="p">:</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">2</span><span class="p">)},</span>
                   <span class="n">entire</span><span class="o">=</span><span class="s1">&#39;search&#39;</span><span class="p">,</span> <span class="n">validation</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[70]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">rf</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Entire Dataset
grid searching
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[70]:
</pre></div>
</div>
<div class="output_area highlight-none notranslate"><div class="highlight"><pre>
<span></span>Sculpture_2019_05_28_16_59
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[71]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">rf</span><span class="o">.</span><span class="n">estimator</span><span class="o">.</span><span class="n">gridSearch</span><span class="o">.</span><span class="n">best_params_</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[71]:
</pre></div>
</div>
<div class="output_area highlight-none notranslate"><div class="highlight"><pre>
<span></span>{&#39;model__ml__max_depth&#39;: 8}
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[72]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">helpers</span><span class="o">.</span><span class="n">view_sk_metric</span><span class="p">(</span><span class="n">rf</span><span class="o">.</span><span class="n">measurements</span><span class="o">.</span><span class="n">outside</span><span class="o">.</span><span class="n">roc_auc_score</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[72]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>score</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>mean</th>
      <td>0.628002</td>
    </tr>
    <tr>
      <th>std</th>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[74]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">helpers</span><span class="o">.</span><span class="n">view_sk_metric</span><span class="p">(</span><span class="n">rf</span><span class="o">.</span><span class="n">measurements</span><span class="o">.</span><span class="n">outside</span><span class="o">.</span><span class="n">average_precision_score</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[74]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>score</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>mean</th>
      <td>0.019321</td>
    </tr>
    <tr>
      <th>std</th>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[75]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">rf</span><span class="o">.</span><span class="n">measurements</span><span class="o">.</span><span class="n">outside</span><span class="o">.</span><span class="n">feature_weights</span><span class="o">.</span><span class="n">mean</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[75]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>feature_importances</th>
    </tr>
    <tr>
      <th>names</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>listing_room_type_Shared Room</th>
      <td>0.000887</td>
    </tr>
    <tr>
      <th>listing_num_recent_reservations</th>
      <td>0.000931</td>
    </tr>
    <tr>
      <th>listing_weekly_discount</th>
      <td>0.001039</td>
    </tr>
    <tr>
      <th>listing_monthly_discount</th>
      <td>0.001068</td>
    </tr>
    <tr>
      <th>listing_weekly_price_factor_exists</th>
      <td>0.001114</td>
    </tr>
    <tr>
      <th>listing_room_type_Entire Home</th>
      <td>0.001137</td>
    </tr>
    <tr>
      <th>listing_has_pro_pictures_True</th>
      <td>0.001138</td>
    </tr>
    <tr>
      <th>query_price_min_exists</th>
      <td>0.001167</td>
    </tr>
    <tr>
      <th>listing_monthly_price_factor_exists</th>
      <td>0.001215</td>
    </tr>
    <tr>
      <th>query_price_max_exists</th>
      <td>0.001218</td>
    </tr>
    <tr>
      <th>listing_cleaning_fee_exists</th>
      <td>0.001306</td>
    </tr>
    <tr>
      <th>listing_has_pro_pictures_False</th>
      <td>0.001538</td>
    </tr>
    <tr>
      <th>query_price_max</th>
      <td>0.001699</td>
    </tr>
    <tr>
      <th>listing_is_new</th>
      <td>0.003268</td>
    </tr>
    <tr>
      <th>query_num_infants</th>
      <td>0.007566</td>
    </tr>
    <tr>
      <th>listing_property_type</th>
      <td>0.010703</td>
    </tr>
    <tr>
      <th>listing_minimum_nights</th>
      <td>0.011393</td>
    </tr>
    <tr>
      <th>query_num_children</th>
      <td>0.011618</td>
    </tr>
    <tr>
      <th>listing_num_bathrooms</th>
      <td>0.012660</td>
    </tr>
    <tr>
      <th>listing_num_beds</th>
      <td>0.012786</td>
    </tr>
    <tr>
      <th>listing_person_capacity</th>
      <td>0.012918</td>
    </tr>
    <tr>
      <th>listing_num_bedrooms</th>
      <td>0.013840</td>
    </tr>
    <tr>
      <th>listing_review_rating</th>
      <td>0.015105</td>
    </tr>
    <tr>
      <th>listing_monthly_price_factor</th>
      <td>0.016882</td>
    </tr>
    <tr>
      <th>query_center_lat</th>
      <td>0.017172</td>
    </tr>
    <tr>
      <th>query_price_min</th>
      <td>0.017585</td>
    </tr>
    <tr>
      <th>listing_weekly_price_factor</th>
      <td>0.017951</td>
    </tr>
    <tr>
      <th>duration_days</th>
      <td>0.018724</td>
    </tr>
    <tr>
      <th>listing_lat</th>
      <td>0.019262</td>
    </tr>
    <tr>
      <th>listing_accuracy_rating</th>
      <td>0.019871</td>
    </tr>
    <tr>
      <th>listing_communication_rating</th>
      <td>0.020330</td>
    </tr>
    <tr>
      <th>listing_cleaning_fee</th>
      <td>0.020799</td>
    </tr>
    <tr>
      <th>query_num_guests</th>
      <td>0.021733</td>
    </tr>
    <tr>
      <th>listing_checkin_rating</th>
      <td>0.023073</td>
    </tr>
    <tr>
      <th>listing_value_rating</th>
      <td>0.024907</td>
    </tr>
    <tr>
      <th>listing_location_rating</th>
      <td>0.025013</td>
    </tr>
    <tr>
      <th>listing_cleanliness_rating</th>
      <td>0.025212</td>
    </tr>
    <tr>
      <th>distance_km</th>
      <td>0.026818</td>
    </tr>
    <tr>
      <th>listing_lng</th>
      <td>0.027505</td>
    </tr>
    <tr>
      <th>query_center_lng</th>
      <td>0.033619</td>
    </tr>
    <tr>
      <th>listing_maximum_nights</th>
      <td>0.034212</td>
    </tr>
    <tr>
      <th>listing_review_count</th>
      <td>0.038879</td>
    </tr>
    <tr>
      <th>listing_num_books_90day</th>
      <td>0.052470</td>
    </tr>
    <tr>
      <th>ts_search</th>
      <td>0.060408</td>
    </tr>
    <tr>
      <th>query_radius</th>
      <td>0.067424</td>
    </tr>
    <tr>
      <th>listing_total_price</th>
      <td>0.071978</td>
    </tr>
    <tr>
      <th>amortized_costs</th>
      <td>0.073792</td>
    </tr>
    <tr>
      <th>listing_occupancy_rate</th>
      <td>0.097069</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span>
</pre></div>
</div>
</div>
<p>While I could spend more time developing this model, given model performance and time constraints I’ll move forward with the logistic regression on the full transformation graph to test the performance on the validation set against the hold out set.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[76]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">gains_validation</span> <span class="o">=</span> <span class="n">ndcg_score</span><span class="p">(</span><span class="n">logit</span><span class="p">)</span>
<span class="n">gains_validation</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;gain&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">bins</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="n">gains_validation</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/anaconda/lib/python2.7/site-packages/ipykernel_launcher.py:12: RuntimeWarning: invalid value encountered in double_scalars
  if sys.path[0] == &#39;&#39;:
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[76]:
</pre></div>
</div>
<div class="output_area highlight-none notranslate"><div class="highlight"><pre>
<span></span>0.8035700967257815
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/ranking_search_86_2.png" src="_images/ranking_search_86_2.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[77]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">gains</span> <span class="o">=</span> <span class="n">ndcg_score</span><span class="p">(</span><span class="n">logit</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">holdout_df</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/anaconda/lib/python2.7/site-packages/ipykernel_launcher.py:12: RuntimeWarning: invalid value encountered in double_scalars
  if sys.path[0] == &#39;&#39;:
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[78]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="k">print</span><span class="p">(</span><span class="n">gains</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
<span class="n">gains</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;gain&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">bins</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
0.801363668521
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[78]:
</pre></div>
</div>
<div class="output_area highlight-none notranslate"><div class="highlight"><pre>
<span></span>array([[&lt;matplotlib.axes._subplots.AxesSubplot object at 0x12b390e10&gt;]],
      dtype=object)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/ranking_search_88_2.png" src="_images/ranking_search_88_2.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[79]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">gains_validation</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;kde&#39;</span><span class="p">)</span>
<span class="n">gains</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;kde&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[79]:
</pre></div>
</div>
<div class="output_area highlight-none notranslate"><div class="highlight"><pre>
<span></span>&lt;matplotlib.axes._subplots.AxesSubplot at 0x1083a6650&gt;
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/ranking_search_89_1.png" src="_images/ranking_search_89_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[80]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">ttest_ind</span>
<span class="n">ttest_ind</span><span class="p">(</span><span class="n">gains</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">gains_validation</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">equal_var</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[80]:
</pre></div>
</div>
<div class="output_area highlight-none notranslate"><div class="highlight"><pre>
<span></span>Ttest_indResult(statistic=-0.4238713631004248, pvalue=0.6716737145685947)
</pre></div>
</div>
</div>
<p>The gains associated with the validation and holdout sets are statistically similar!</p>
<div class="section" id="Model-Development:-future-work">
<h4>Model Development: future work<a class="headerlink" href="#Model-Development:-future-work" title="Permalink to this headline">¶</a></h4>
<p>For the scoring component of the model, depending on the available data and infrastucture, I’d next look to a feed forward neural network after limited gains were made with Logistic Regression and the Random Forest. I’ve perturbed the hyperparameters and seen no substantial changes in scores (not shown fully) and I do not believe it would be worthwhile from a cost benefit perspective to spend resources finely grid searching the hyperparameter space for either of those two models.</p>
<p>More important to the model’s ability to learn, and assuming a larger time window, developing more features about user preferences, via aggregations or personas through clustering could be a great next step. This work could be approached by classical clustering techniques as well as generating embeddings with auto-encoders in addition to identifying anomalies with isolation forests. While more nuanced than other two sided marketplaces because of uniqueness of supply and the phasing in and out of
listings as available, one of the important areas not explored here yet is leveraging the suite of matrix factorization techniques to enable the model to share information between users.</p>
<p>Last, our current framework suffers from a large (almost 1:100) class imbalance. Leveraging a synthetic technique like SMOTE (or even oversampling) to attempt to gain a better understanding of the dividing surface between bookings and not booking could be impactful.</p>
</div>
</div>
</div>
<div class="section" id="New-Listings:-UX,-dispersion,-and-ML-scoring">
<h2>New Listings: UX, dispersion, and ML scoring<a class="headerlink" href="#New-Listings:-UX,-dispersion,-and-ML-scoring" title="Permalink to this headline">¶</a></h2>
<p>One nice attribtue of ‘clear’ box models is we can see clearly why they made the decisions they made. Here we can see from our logit that having positive reviews, and simply having guests stay promotes booking. Not surprisingly, people prefer pre-vetted experiences. As a result, the scoring model promotes listing with strong reputations, an artifact of having had guests stay. New listings then suffer from having no reviews.</p>
<p>If this system launched as is the long term health of AirBnB would be negatively affected because new listings would struggle to surface. This spiral phenomena would in turn impede the listings chance to surface in the future and of gaining reviews. Frustrated owners would stop listing or be discouraged from listing homes.</p>
<p>A well designed ML system should augment and guide a product, not expect the product to follow it blindly (save the rare case where the system and the product are in fact 100% aligned). To acheive this our system needs to actively promote new listings. We can have a meta-model on our system that is trained to evaluate the bias against new listing through the viewing newness as the <code class="docutils literal notranslate"><span class="pre">treatment</span></code> and the model predicts that impact. We can then adjust the scores of the new listings upward by the
predicted amount. If there’s a strong incentive from AirBnB’s perspective to promote new listings we can enforce additional policy such as one or more of the top-k is a new listing or 2x the treatment from the bias adjustment. All of these approaches would yield an effective decrease in the ndcg of the system but lead to a healthier marketplace.</p>
<p>Dispersion is imperative in serving content. The manner in which listings are served can impact the trust a user has in the platform. In a hypothetical limiting case, consider an apartment building with several (say 20) nearly idential apartments. That apartment archetype’s score is the most bookable for a user, but serving all 20 of those listing as the first 20 listings would not be a good user experience.</p>
<p>I’ve already talked about integrating with the existing search infrastructure so I’ll conclude by mentioning an idea to leverage these scores in a completely different way. Typically search is thought as a stream from top to bottom, but being a web based application provides more interesting opportunity. This style of scoring system can help understand the value of “real estate” on the screen and the different techniques available to visually serve listings. Helping answer questions like where
should the top ranked listing be placed on the screen as well as supporting other design choices not just with data, but with the ability to support inference on those techniques.</p>
<p>These two transformers had negative impacts on model performance, but I think could merit further investigation with a larger window of time =&gt; larger volume of a user’s history</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[81]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="k">class</span> <span class="nc">Pricepoint</span><span class="p">(</span><span class="n">transformers</span><span class="o">.</span><span class="n">DatasetTransformer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Augment with difference of mean of amortized costs over user&#39;s cumalitve previous interactions</span>
<span class="sd">    and current listsings costs</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nd">@data.package_dataset</span>
    <span class="nd">@data.extract_fields</span>
    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">dataset</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">designData</span>
        <span class="n">collection</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">interactions</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">label</span> <span class="o">!=</span> <span class="s1">&#39;impression&#39;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">user</span><span class="p">,</span> <span class="n">subset</span> <span class="ow">in</span> <span class="n">interactions</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;id_user&#39;</span><span class="p">):</span>
            <span class="n">subset</span> <span class="o">=</span> <span class="n">subset</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;ts_search&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">subset</span><span class="p">):</span>
                <span class="n">avg_cost_per_search</span> <span class="o">=</span> <span class="n">subset</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;ts_search&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">amortized_costs</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;ts_search&#39;</span><span class="p">)</span>
                <span class="n">avg_cost_per_search</span><span class="p">[</span><span class="s1">&#39;prior_mean_avg_cost&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">avg_cost_per_search</span><span class="o">.</span><span class="n">amortized_costs</span><span class="o">.</span><span class="n">expanding</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                <span class="n">avg_cost_per_search</span><span class="p">[</span><span class="s1">&#39;id_user&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">user</span>
                <span class="n">collection</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">avg_cost_per_search</span><span class="p">[[</span><span class="s1">&#39;id_user&#39;</span><span class="p">,</span> <span class="s1">&#39;prior_mean_avg_cost&#39;</span><span class="p">,</span> <span class="s1">&#39;ts_search&#39;</span><span class="p">]])</span>

        <span class="n">lookup</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">collection</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;ts_search&#39;</span><span class="p">)</span>
        <span class="n">lookup</span><span class="p">[</span><span class="s1">&#39;ts_search&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lookup</span><span class="o">.</span><span class="n">ts_search</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lookup</span> <span class="o">=</span> <span class="n">lookup</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;ts_search&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="nd">@data.extract_features</span>
    <span class="nd">@data.enforce_dataset</span>
    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">dataset</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">designData</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;ts_search&#39;</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;ts_search&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">ts_search</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="n">df_t</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge_asof</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;ts_search&#39;</span><span class="p">,</span> <span class="n">by</span><span class="o">=</span><span class="s1">&#39;id_user&#39;</span><span class="p">,</span>
                <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;backward&#39;</span><span class="p">,</span> <span class="n">allow_exact_matches</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>

        <span class="n">df_t</span><span class="p">[</span><span class="s1">&#39;prior_mean_avg_cost_delta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_t</span><span class="o">.</span><span class="n">amortized_costs</span> <span class="o">-</span> <span class="n">df_t</span><span class="o">.</span><span class="n">prior_mean_avg_cost</span>
        <span class="n">df_t</span> <span class="o">=</span> <span class="n">df_t</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;prior_mean_avg_cost&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">dataset</span><span class="o">.</span><span class="n">with_params</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">df_t</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">targetData</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">DaysSearches</span><span class="p">(</span><span class="n">transformers</span><span class="o">.</span><span class="n">DatasetTransformer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Count of user&#39;s searches executed previously that day</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nd">@data.package_dataset</span>
    <span class="nd">@data.extract_features</span>
    <span class="nd">@data.enforce_dataset</span>
    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">dataset</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">designData</span>
        <span class="n">collection</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">interactions</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">label</span> <span class="o">!=</span> <span class="s1">&#39;impression&#39;</span><span class="p">]</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">day</span><span class="p">),</span> <span class="n">subset</span> <span class="ow">in</span> <span class="n">interactions</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;id_user&#39;</span><span class="p">,</span> <span class="s1">&#39;ds_search&#39;</span><span class="p">]):</span>
            <span class="n">subset</span> <span class="o">=</span> <span class="n">subset</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;ts_search&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">subset</span><span class="p">):</span>
                <span class="n">num_searches</span> <span class="o">=</span> <span class="n">subset</span><span class="p">[[</span><span class="s1">&#39;id_user&#39;</span><span class="p">,</span> <span class="s1">&#39;ts_search&#39;</span><span class="p">]]</span>
                <span class="n">num_searches</span><span class="p">[</span><span class="s1">&#39;prior_searches&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">subset</span><span class="o">.</span><span class="n">id_search</span><span class="o">.</span><span class="n">expanding</span><span class="p">()</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
                <span class="n">num_searches</span><span class="p">[</span><span class="s1">&#39;id_user&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">user</span>
                <span class="n">num_searches</span><span class="p">[</span><span class="s1">&#39;id_user&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">user</span>
                <span class="n">collection</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">num_searches</span><span class="p">)</span>

        <span class="n">lookup</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">collection</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;ts_search&#39;</span><span class="p">)</span>
        <span class="n">lookup</span><span class="p">[</span><span class="s1">&#39;ts_search&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lookup</span><span class="o">.</span><span class="n">ts_search</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;ts_search&#39;</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;ts_search&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">ts_search</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="n">df_t</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge_asof</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(),</span> <span class="n">lookup</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;ts_search&#39;</span><span class="p">,</span> <span class="n">by</span><span class="o">=</span><span class="s1">&#39;id_user&#39;</span><span class="p">,</span>
                <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;backward&#39;</span><span class="p">,</span> <span class="n">allow_exact_matches</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">dataset</span><span class="o">.</span><span class="n">with_params</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">df_t</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">targetData</span><span class="p">)</span>

</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span>
</pre></div>
</div>
</div>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="donatello.html" class="btn btn-neutral float-right" title="donatello package" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="model_types.html" class="btn btn-neutral" title="Model Types" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Mark Weiss.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'0.0.1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>
      <script type="text/javascript" src="_static/language_data.js"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>