Sculpture
=========

To get started, connect a dataset via
:py:class:`donatello.components.data.Dataset` and
:py:class:`donatello.components.estimator.Estimator` to
:py:class:`donatello.components.core.Sculpture`

Sculptures are modeling object that uphold scikit-learn's estimator contracts

    #. ``__init__`` cannot mutate parameters
    #. ``get_params`` and ``set_params`` support
    #. ``fit``, ``transform``, and ``fit_transform`` support


Sculptures can be embedded as nodes in :py:class:`donatello.components.transformers.ModelDAG` as well 
as transformers in :py:class:`sklearn.pipeline.Pipeline`

Donatello approaches model configuration as declaring intent. Everything required
to build evaluate and produce artifacts is specified during instantiation.


Intent
------

.. code:: python


    import pandas as pd

    from sklearn.datasets import load_breast_cancer
    from sklearn.linear_model import LogisticRegression
    from sklearn.metrics import roc_auc_score, average_precision_score

    from donatello.components.data import Dataset
    from donatello.components.estimator import Estimator
    from donatello.components.measure import Metric, FeatureWeights, ThresholdRates
    from donatello.components.core import Sculpture


    def load_sklearn_bc_dataset():
        """
        Helper to load sklearn dataset into a pandas dataframe

        Returns:
            pd.DataFrame: X and y combined
        """
        dataset = load_breast_cancer()
        df = pd.DataFrame(data=pd.np.c_[dataset['data'], dataset['target']],
                          columns=(dataset['feature_names'].tolist() + ['is_malignant'])
                          )
        return df


    def load_sculpture():
        """
        Helper to load sculpture
        """
        dataset = Dataset(raw=load_sklearn_bc_dataset(), target='is_malignant')

        estimator = Estimator(model=LogisticRegression(),
                              paramGrid={'model__C': list(pd.np.logspace(-2, 0, 5))},
                              searchKwargs={'scoring': 'roc_auc', 'cv': 3},
                              method='predict_proba',
                              scorer='score_second'
                              )

        metrics = [Metric(roc_auc_score), Metric(average_precision_score),
                   FeatureWeights(sort='coefficients'), ThresholdRates()]

        sculpture = Sculpture(dataset=dataset, estimator=estimator, metrics=metrics)

        return sculpture


    sculpture = load_sculpture()


Declaration
-----------

Sculptures are declaratively defined modeling objects enabling
repeatable and traceable experimentation. Donetallo's framework
attempts to follow scikit-learn's pattern with an eye toward
improving utilization with pandas.

.. code:: python

    sculpture.declaration


.. parsed-literal::

    {'dataset': Dataset_2019_03_24_13_02,
     'entire': False,
     'estimator': Estimator_2019_03_24_13_02,
     'holdOut': True,
     'measure': Measure_2019_03_24_13_02,
     'metrics': [roc_auc_score_2019_03_24_13_02,
                 average_precision_score_2019_03_24_13_02,
                 feature_weights_2019_03_24_13_02,
                 ThresholdRates_2019_03_24_13_02],
     'persist': <function donatello.utils.helpers.persist>,
     'storeReferences': True,
     'timeFormat': '%Y_%m_%d_%H_%M',
     'validation': True,
     'writeAttrs': ('', 'estimator')}



The ``validation``, ``holdOut``, and ``entire`` flags dictate
over which (subsets) of data estimators are fit and metrics are calculated (if applicable)


.. parsed-literal::

    'validation': True,
    'holdOut': True,
    'entire': False


The metrics list is a collection of :py:class:`donatello.components.measure.Metric` objects
which fit calculate statistics around model performance, which can either wrap a 
scikit-learn metric or execute custom scoring functionality. If information needs
to be shared across folds for computation, it can be stored during the ``fit`` method.


.. code:: python

     'metrics': [roc_auc_score_2019_03_24_13_02,
                 average_precision_score_2019_03_24_13_02,
                 feature_weights_2019_03_24_13_02,
                 ThresholdRates_2019_03_24_13_02]



Fitting
-------

The sculputre's fit method defaults to instructions provided during instantiation.

Declared by the given flags above, this sculpture will perform a 5 fold
stratified K Fold cross validation within the training subset of the data
and then fit a model over the entire training set and evaluate on the hold out set.

Per scikit-learn Transformer pattern, fitting returns the object itslef

``sculpture.fit() == sculpture.fit(dataset=sculpture.dataset)``
                    
.. code:: python

    sculpture.fit()


.. parsed-literal::

    Building Over Cross Validation
    grid searching
    grid searching
    grid searching
    grid searching
    grid searching

    Building Over Cross Validation
    grid searching

    Sculpture_2019_03_24_13_02



Evaluating
----------

During the fitting process, metrics are calculated over the
specified samples of data and stored in a :py:class:`sklearn.utils.Bunch`
(a lighlty wrapped dict, with attribute style accessors)

This information is attached to the Sculpture in the ``measurements`` attribute


.. code:: python

    sculpture.measurements.keys()

    ['crossValidation', 'holdOut']



.. code:: python

    sculpture.measurements.crossValidation.keys()

    ['ThresholdRates',
     'roc_auc_score',
     'feature_weights',
     'average_precision_score']




The default aggregations are ``mean`` and ``std`` which are collected into a Bunch as well.

.. code:: python

    sculpture.measurements.crossValidation.average_precision_score

    {'mean':           0
     _          
     0  0.994795, 'std':           0
     _          
     0  0.003311}


Because all scikit-learn scorers and many metrics are scalar returns
:py:func:`donatello.utils.helpers.view_sk_metric` will unfurl the bunch
into a flat table


.. code:: python

    from donatello.utils import helpers
    helpers.view_sk_metric(sculpture.measurements.crossValidation.average_precision_score)

.. include:: tables/pr_score.rst



The feature weights metric is a short cut to pulling coefficients for glms
and feature_importances from ensemble method


.. code:: python

    sculpture.measurements.crossValidation.feature_weights.mean


.. include:: tables/feature_weights.rst


The Threshold Rates Metric helps parameterize the binary confusion matrix
by sampling scores from the held out data and evaluting the 

.. code:: python

    sculpture.measurements.crossValidation.ThresholdRates.mean[['precision', 'recall']].loc[::5]

.. include:: tables/threshold_rates.rst

Persisting
----------

Donatello produces artifacts to enable traceability and distribution.
Objects are persribed through donatello's data accesss protocal (dap)
which gives  nested access and lazy evaluation to enable simple and narrow
user defined flexibility

.. code:: python

    ls *pkl


    Estimator.pkl  Sculpture.pkl
